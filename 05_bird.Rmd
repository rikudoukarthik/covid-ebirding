---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Bird behaviour

Two sets of bird species will be selected, one of birds common in human-dominated areas, and the other of common birds that are not very common in human-dominated areas. Reporting frequencies of all species will be calculated for every month and year. If there is an increase during the Mar--May period of birds in the first set and a decrease of birds in the second set, this means that birdwatcher bias has affected bird abundance as seen from the data.

```{r b_setup, cache=TRUE, message=FALSE}

load("data/data0_MY_b.RData")
load("data/data0_MY_b_slice.RData")

### bird species to analyse/compare ####

# Guwahati lacks PBFl, WCBa (but BTBa), InRo, GrFr, PiBu, BWKi, GHSw (in good numbers)
# Ernakulam lacks GrFr, SmMi, BWKi, LTSh, PiBu (in good numbers)
# different from list for BLR and PUN because 5 non-urban species from that list do not occur in sufficient numbers in EKM

species_bang <- data.frame(
  COMMON.NAME = c("House Crow", "Common Myna", "Jungle Myna", "Rock Pigeon", "Black Kite", "Common Tailorbird", "Rose-ringed Parakeet", "Asian Koel", "Purple Sunbird", "Pale-billed Flowerpecker", "White-cheeked Barbet", 
                  "Little Cormorant", "Gray-headed Swamphen", "Indian Pond-Heron",
                  "Green Bee-eater", "Black Drongo", "Pied Bushchat", "Plain Prinia", "Indian Robin", "House Sparrow", "Spotted Dove", "Coppersmith Barbet", "Black-winged Kite", "Small Minivet", "Long-tailed Shrike", "Gray Francolin"),
  SP.CATEGORY = c(rep("U", 11), rep("W", 3), rep("R", 12)))

# removing Black Drongo for models to run
species_pune <- data.frame(
  COMMON.NAME = c("House Crow", "Common Myna", "Jungle Myna", "Rock Pigeon", "Black Kite", "Common Tailorbird", "Rose-ringed Parakeet", "Asian Koel", "Purple Sunbird", "Pale-billed Flowerpecker", "White-cheeked Barbet", 
                  "Little Cormorant", "Gray-headed Swamphen", "Indian Pond-Heron",
                  "Green Bee-eater", "Pied Bushchat", "Plain Prinia", "Indian Robin", "House Sparrow", "Spotted Dove", "Coppersmith Barbet", "Black-winged Kite", "Small Minivet", "Long-tailed Shrike", "Gray Francolin"),
  SP.CATEGORY = c(rep("U", 11), rep("W", 3), rep("R", 11)))

species_koch <- data.frame(
  COMMON.NAME = c("House Crow", "Common Myna", "Jungle Myna", "Rock Pigeon", "Black Kite", "Common Tailorbird", "Rose-ringed Parakeet", "Asian Koel", "Purple Sunbird", "Pale-billed Flowerpecker", "White-cheeked Barbet", 
                  "Little Cormorant", "Gray-headed Swamphen", "Indian Pond-Heron",
                  "Green Bee-eater", "Black Drongo", "Plain Prinia", "Indian Robin", "House Sparrow", "Spotted Dove", "Coppersmith Barbet", "White-throated Kingfisher", "Black-rumped Flameback", "Rufous Treepie"),
  SP.CATEGORY = c(rep("U", 11), rep("W", 3), rep("R", 10)))


species_guwa <- data.frame(
  COMMON.NAME = c("House Crow", "Common Myna", "Jungle Myna", "Rock Pigeon", "Black Kite", "Common Tailorbird", "Rose-ringed Parakeet", "Asian Koel", "Purple Sunbird", "Blue-throated Barbet",
                  "Little Cormorant", "Indian Pond-Heron",
                  "Green Bee-eater", "Black Drongo", "Plain Prinia", "House Sparrow", "Spotted Dove", "Coppersmith Barbet", "White-throated Kingfisher", "Rufous Treepie", "Long-tailed Shrike"),
  SP.CATEGORY = c(rep("U", 10), rep("W", 2), rep("R", 9)))


species_list <- bind_rows("Karnataka" = species_bang,
                          "Maharashtra" = species_pune,
                          "Kerala" = species_koch,
                          "Assam" = species_guwa,
                          .id = "STATE") %>% 
  filter(!(SP.CATEGORY %in% "W")) # removing wetland spp. cos we want to compare UNU

rm(species_bang, species_pune, species_koch, species_guwa)


### choosing grid cells of 4 cities ####

# library(leaflet)
# 
# leaflet() %>%
#   addTiles() %>%
#   addPolygons(data = districtmap, color = "#000000",
#               label = sp::getSpPPolygonsIDSlots(districtmap)) %>%
#   addPolygons(data = gridmapg1, color = "#000000",
#               label = sp::getSpPPolygonsIDSlots(gridmapg1))

# selecting metropolitan subset of cells covered by district
city_bang <- c(13821, 13822, 13823, 13951, 13952, 13953, 14082, 14083)
city_pune <- c(10685, 10686)
city_koch <- c(15636, 15637, 15766, 15767)
city_guwa <- c(6345)

city_list <- data.frame(CITY = c(rep("Bengaluru", 8), rep("Pune", 2), 
                                 rep("Kochi", 4), "Guwahati"),
                        CELLS = c(city_bang, city_pune, city_koch, city_guwa),
                        COUNTY = c(rep("Bengaluru Urban", 8), rep("Pune", 2), 
                                   rep("Ernakulam", 4), "Kamrup Metropolitan"),
                        STATE = c(rep("Karnataka", 8), rep("Maharashtra", 2), 
                                  rep("Kerala", 4), "Assam")) %>% 
  mutate(STATE = factor(STATE, levels = anal_states[1,])) %>% 
  arrange(STATE)

rm(city_bang, city_pune, city_koch, city_guwa)

### highly birded personal locations ####

# eBird user info
eBird_users <- read.delim("data/ebd_users_relMay-2022.txt", 
                          sep = "\t", header = T, quote = "", 
                          stringsAsFactors = F, na.strings = c(""," ",NA)) %>% 
  transmute(OBSERVER.ID = observer_id,
            FULL.NAME = paste(first_name, last_name, sep = " "))

# # list of prolific birders judging from eBird India leaderboard
# prolific_a <- data.frame(FULL.NAME = c("Renju TR", "Jayadev  Menon", "Steffin Babu",
#                          "Panchapakesan Jeganathan", "Premchand Reghuvaran", "Sahana M")) %>% 
#   left_join(eBird_users)

# getting overall checklist leaders from data
prolific_a <- data0_MY_b_slice_S %>% 
  group_by(OBSERVER.ID, LOCALITY.ID, LOCALITY) %>% 
  dplyr::summarise(TOT.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>% 
  ungroup() %>% 
  filter(TOT.LISTS >= 800) %>% # 200 per year threshold (arbitrary)
  arrange(desc(TOT.LISTS)) %>% 
  left_join(eBird_users) %>% 
  dplyr::select(-TOT.LISTS)
  

# getting checklist leaders with equal effort across years from data
prolific_b <- data0_MY_b_slice_S %>% 
  group_by(OBSERVER.ID, LOCALITY.ID, LOCALITY, M.YEAR, MONTH) %>% 
  dplyr::summarise(MONTH.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>% 
  filter(MONTH.LISTS >= 15) %>% # 200 per year roughly translates to 16 per month
  dplyr::summarise(N = n_distinct(MONTH),
            TOT.LISTS = sum(MONTH.LISTS)) %>% 
  filter(N >= 10) %>% # at least 10 months in a year
  dplyr::summarise(N = n_distinct(M.YEAR),
            TOT.LISTS = sum(TOT.LISTS)) %>% 
  filter(N == 4) %>% # all four years
  ungroup() %>% 
  arrange(desc(TOT.LISTS)) %>% 
  left_join(eBird_users) %>% 
  dplyr::select(-N, -TOT.LISTS)

prolific <- inner_join(prolific_a, prolific_b)

rm(prolific_a, prolific_b)



### preparing data for prolific models ####

# species list (all species included in list for other analyses, across all states)
species_prolific <- species_list %>% distinct(COMMON.NAME, SP.CATEGORY)


# to join for presence-absence of various species
temp1 <- data0_MY_b %>% 
  right_join(prolific) %>% 
  group_by(SAMPLING.EVENT.IDENTIFIER, COMMON.NAME) %>% 
  dplyr::summarise(OBSERVATION.COUNT = max(OBSERVATION.COUNT)) %>% 
  ungroup()

# to later join checklist metadata
temp2 <- data0_MY_b_slice_S %>% 
  right_join(prolific) %>% 
  dplyr::select(OBSERVER.ID, LOCALITY.ID, SAMPLING.EVENT.IDENTIFIER)

# join patches with patch-specific species
temp3 <- data0_MY_b %>% 
  right_join(prolific) %>% 
  group_by(LOCALITY.ID) %>% 
  filter(COMMON.NAME %in% species_prolific$COMMON.NAME) %>% 
  distinct(LOCALITY.ID, COMMON.NAME)


data_prolific <- temp2 %>% 
  group_by(OBSERVER.ID, LOCALITY.ID, SAMPLING.EVENT.IDENTIFIER) %>% 
  # for every list from a person's patch, adding all possible species for the patch
  left_join(temp3) %>% 
  # joining observation count to species, and will replace NAs with 0
  left_join(temp1) %>% 
  mutate(REPORT = replace_na(OBSERVATION.COUNT, "0"),
         OBSERVATION.COUNT = NULL) %>% 
  # converting counts to presences
  mutate(REPORT = as.numeric(case_when(REPORT != "0" ~ "1", TRUE ~ REPORT))) %>% 
  ungroup()


# FILTERS:
# - calculating overall (12 months, 4 years) repfreq for each patch-species combo to 
#   filter out very uncommon species based on threshold.
# - also removing species only "present" (same threshold) in one locality because 
#   cannot use random effect with only one level in model.
#
# - finally, removing locations where after above filters, both sp. categ. do not exist

temp2a <- temp2 %>% 
  group_by(OBSERVER.ID, LOCALITY.ID) %>% 
  dplyr::summarise(TOT.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>% 
  ungroup()

filt <- data_prolific %>% 
  group_by(OBSERVER.ID, LOCALITY.ID, COMMON.NAME) %>% 
  # data_prolific is list-level, so some patch-species combos will be 0 in certain lists
  # interested in species repfreq for each patch, so here removing 0 to count presences
  filter(REPORT != 0) %>% 
  dplyr::summarise(NO.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>% 
  ungroup() %>% 
  right_join(temp2a) %>% 
  mutate(PROP.LISTS = 100*NO.LISTS/TOT.LISTS) %>% 
  # filtering for species present in threshold lists 
  # (RoPi with 11% not converging in max iterations so setting threshold at 15, not 10)
  filter(PROP.LISTS >= 15) %>%
  # removing species present only in one locality
  group_by(COMMON.NAME) %>% 
  mutate(N.LOC = n_distinct(LOCALITY.ID)) %>%
  ungroup() %>% 
  filter(N.LOC > 1) %>% 
  distinct(COMMON.NAME, LOCALITY.ID) %>%
  arrange(COMMON.NAME, LOCALITY.ID) 

data_prolific <- data_prolific %>% 
  # filtering for patch-species combos present in threshold lists at >1 locality
  right_join(filt) %>% 
  arrange(OBSERVER.ID, LOCALITY.ID, SAMPLING.EVENT.IDENTIFIER, COMMON.NAME) %>% 
  # joining list length, year and month metadata
  left_join(data0_MY_b_slice_S %>% distinct(SAMPLING.EVENT.IDENTIFIER, NO.SP, M.YEAR, MONTH)) %>%
  # joining species info
  left_join(species_prolific) %>% 
  # filtering out locations where both species categories do not exist (after species filters)
  group_by(LOCALITY.ID) %>% 
  mutate(N.SPC = n_distinct(SP.CATEGORY)) %>% 
  ungroup() %>% 
  filter(N.SPC == 2) %>% 
  mutate(N.SPC = NULL)
  

### species for which cloglog failing ####

# overall bird models (b01_overall_model.R) generally binomial with cloglog but
# for some species in KL and MH, using cloglog link is resulting in "PIRLS step-halvings 
# failed to reduce deviance in pwrssUpdate" or other convergence issues.
# so for these, we use logit instead

fail_spec_KL <- c("Black Drongo", "Jungle Myna", "Common Myna", "Green Bee-eater", 
                  "Spotted Dove", "White-throated Kingfisher")
fail_spec_MH <- c("Common Myna", "Rock Pigeon", "Small Minivet", "Green Bee-eater")

```

## Overall species reporting

```{r b01_overall_s1, cache=TRUE, message=FALSE}

anal_name <- "b01_overall_s1a_m"

b01_overall_monthly("Karnataka")


anal_name <- "b01_overall_s1b_y"

b01_overall_annual("Karnataka")

```

Nothing conclusively due to the pandemic or in one particular direction, at the scale of Bengaluru city. At the scale of the entire state though, some non-urban species showed lower reporting only during April of 2020 (first lockdown).

At the annual level:

Urban species show a wide range of patterns, often contradictory. But many show a very slight decrease during the pandemic year, which is contrary to the prediction of a pandemic effect. Most non-urban species saw a decline in reporting in the pandemic year in Bengaluru city. Both these patterns soften out when averaged across space, i.e., effect sizes shrink at the level of the entire state of Karnataka.

```{r b01_overall_s1c_model, cache=TRUE, message=FALSE}

anal_name <- "b01_overall_s1c_model"
state_name <- "Karnataka"


source("scripts/b01_overall_model.R")
# 341 mins

# saving modelled data
save(birds_pred, data_occ, 
     file = glue("outputs/{anal_name}.RData"))



# loading modelled data
load(glue("outputs/{anal_name}.RData"))

birds_plot <- gg_b_model(birds_pred, type = "overall")

# saving plots
ggsave(filename = glue("03_wrap_figs/{anal_name}.png"), plot = birds_plot,
       dpi = 300, width = 16, height = 7, units = "in")

```

-   At the annual level, urban species did not show a higher reporting frequency, which could be because birders in Karnataka compensated during the winter months with exceptional non-urban birding.
-   The crucial months like April and May show higher reporting frequency for urban species but not for non-urban species.
-   Changes in birder behaviour during the peak period did not translate to notable changes in reporting frequency of bird species at the larger temporal scale.

```{r b01_overall_s2, cache=TRUE, message=FALSE}

anal_name <- "b01_overall_s2a_m"

b01_overall_monthly("Kerala")


anal_name <- "b01_overall_s2b_y"

b01_overall_annual("Kerala")

```

No prominent effect of the pandemic, except PBF (increased) and SpDo (decreased) in April 2020 for Kerala state. The effect of the pandemic seems much less pronounced than in Karnataka. At the scale of Kochi, there is no prominent effect, though a lot of species-months combos in Kochi have very little data.

At the annual level in Kochi, only a few species seem to have been clearly affected by the pandemic. However, overall there is no clear directional pattern. Even with non-urban species, many increased during the pandemic. For the entire state, many patterns even out. One notable exception is White-throated Kingfisher which decreased significantly in MY2019 but bounced back.

```{r b01_overall_s2c_model, cache=TRUE, message=FALSE}

anal_name <- "b01_overall_s2c_model"
state_name <- "Kerala"


source("scripts/b01_overall_model.R")
# 402 min

# saving modelled data
save(birds_pred, data_occ, 
     file = glue("outputs/{anal_name}.RData"))



# loading modelled data
load(glue("outputs/{anal_name}.RData"))

birds_plot <- gg_b_model(birds_pred, type = "overall")

# saving plots
ggsave(filename = glue("03_wrap_figs/{anal_name}.png"), plot = birds_plot,
       dpi = 300, width = 16, height = 7, units = "in")

```

-   At the annual level, there is a slight increase in urban species reporting, but there is also a similar increase in non-urban species reporting.
-   This is in fact due to finer-scale mirroring of patterns. Even during the peak pandemic period, both categories of species saw an increase in reporting. This is true for the other ten months as well, although the change is much smaller.
-   Since reporting of both kinds of species were affected similarly, there is no bias in the pandemic data. Moreover, although there was a change, it was of a relatively small magnitude.

```{r b01_overall_s3, cache=TRUE, message=FALSE}

anal_name <- "b01_overall_s3a_m"

b01_overall_monthly("Maharashtra")


anal_name <- "b01_overall_s3b_y"

b01_overall_annual("Maharashtra")

```

Only a couple of non-urban species decreased during the peak months in Pune city. Also, WCBa is rare in Pune city so can be ignored at this level. In the state as a whole, a couple of urban species and some non-urban species (more than urban) showed a decline during the peak months.

At the annual scale in Pune, many non-urban species declined in MY2019 but only some of them bounced back. In the whole state, this softens and evens out.

```{r b01_overall_s3c_model, cache=TRUE, message=FALSE}

anal_name <- "b01_overall_s3c_model"
state_name <- "Maharashtra"


source("scripts/b01_overall_model.R")
# 221 min

# saving modelled data
save(birds_pred, data_occ, 
     file = glue("outputs/{anal_name}.RData"))



# loading modelled data
load(glue("outputs/{anal_name}.RData"))

birds_plot <- gg_b_model(birds_pred, type = "overall")

# saving plots
ggsave(filename = glue("03_wrap_figs/{anal_name}.png"), plot = birds_plot,
       dpi = 300, width = 16, height = 7, units = "in")

```

-   At the annual level, both urban and non-urban species increased in MY2019, but they haven't reverted to pre-pandemic levels, suggesting that this is perhaps due to an increase in birding in Maharashtra. However, urban species have been more stable after MY2019 than non-urban.
-   Maharashtra is the only state where urban species clearly increased and non-urban species clearly decreased during the peak pandemic months. Both have since returned to normal.
-   In the other ten months, both kinds of species increased in MY2019, but urban species are being reported more and more even after the pandemic has passed. This might have something to do with the kind of birding that has been increasing in Maharashtra.

```{r b01_overall_s4, cache=TRUE, message=FALSE}

anal_name <- "b01_overall_s4a_m"

b01_overall_monthly("Assam")


anal_name <- "b01_overall_s4b_y"

b01_overall_annual("Assam")

```

Small spatial scale (city) for Assam has only one grid cell, so no variation and no CIs. There is absolutely no overall pattern at any of the scales suggesting any effect of the pandemic on bird reporting (either positive or negative). Some urban species showed an increase in Guwahati at the annual scale, but so did some non-urban species (while others showed a decrease). There is no clear directionality. This very much evens out at the level of state.

```{r b01_overall_s4c_model, cache=TRUE, message=FALSE}

anal_name <- "b01_overall_s4c_model"
state_name <- "Assam"


source("scripts/b01_overall_model.R")
# 60 min
# Long-tailed Shrike models for month type 1 and 3 are rank-deficient so drops 1 coefficient

# saving modelled data
save(birds_pred, data_occ, 
     file = glue("outputs/{anal_name}.RData"))



# loading modelled data
load(glue("outputs/{anal_name}.RData"))

birds_plot <- gg_b_model(birds_pred, type = "overall")

# saving plots
ggsave(filename = glue("03_wrap_figs/{anal_name}.png"), plot = birds_plot,
       dpi = 300, width = 16, height = 7, units = "in")

```

-   Unlike other states, Assam showed similar reporting of urban and non-urban species before the pandemic, but since has higher urban reporting. This could be due to the kind of birding that has been growing in the state, which has seen a significant growth in the last few years. Even in MY2019, non-urban reporting did not decrease, but urban reporting just increased.
-   The gap between urban and non-urban birding proportion has been (very) gradually decreasing since MY2019. This might suggest that this was indeed an effect of the pandemic.
-   How is this related to Bihu Bird Count which started in MY2019, and to general rise in popularity of birding as well as skill of birders in Assam?

## Bird reporting with standard effort

Out of the most commonly observed species in each of the "prolific" locations, will retain those that are included in species list made for other analysis.

Not modelling for each species separately because small data size.

This is not done for individual states, because focus is individual locations which are anyway spread across the country.

```{r b02_prolific_model, cache=TRUE, message=FALSE}

anal_name <- "b02_prolific_model"

# models ------------------------------------------------------------

### Model run separately for each location, and species variables included in model 

# Lockdown and non-lockdown months modelled separately, since the month variable in
# model otherwise pulled to a very different average 


data_prolific0 <- bind_rows("LD" = data_prolific %>% filter(MONTH %in% 4:5), 
                            "NL" = data_prolific %>% filter(!(MONTH %in% 4:5)), 
                            "ALL" = data_prolific, 
                            .id = "MONTHS.TYPE") %>% 
  # removing Janardhan Uppada's patch in non-lockdown since it is not converging
  filter(!(MONTHS.TYPE == "NL" & LOCALITY.ID == "L6949429"))

# getting median list length (patch-wise) for prediction later
median_length <- data_prolific0 %>% 
  distinct(MONTHS.TYPE, LOCALITY.ID, M.YEAR, MONTH, SAMPLING.EVENT.IDENTIFIER, NO.SP) %>% 
  group_by(MONTHS.TYPE, LOCALITY.ID, MONTH) %>% 
  dplyr::summarise(NO.SP.MED = floor(median(NO.SP)))

# dataframe with empty column to populate with looped values
prolific_pred <- data_prolific0 %>% 
  group_by(MONTHS.TYPE, LOCALITY.ID) %>% 
  tidyr::expand(nesting(MONTH), M.YEAR, SP.CATEGORY) %>% 
  ungroup() %>% 
  # joining median list length
  left_join(median_length) %>% 
  rename(NO.SP = NO.SP.MED) %>% 
  mutate(PRED.LINK = NA,
         SE.LINK = NA)


for (cur_m in 1:n_distinct(prolific_pred$MONTHS.TYPE)) {
  
  data_mtype <- data_prolific0 %>% 
    filter(MONTHS.TYPE == unique(prolific_pred$MONTHS.TYPE)[cur_m])
  
  prolific_pred0 <- prolific_pred %>% 
    filter(MONTHS.TYPE == unique(prolific_pred$MONTHS.TYPE)[cur_m]) %>% 
    rename(PRED.LINK2 = PRED.LINK,
           SE.LINK2 = SE.LINK)
  
  count <- 0
  for (l in 1:n_distinct(prolific_pred0$LOCALITY.ID)) {
    
    data_loc <- data_mtype %>% 
      filter(LOCALITY.ID == unique(prolific_pred0$LOCALITY.ID)[l])
    
    tictoc::tic(glue("GLMM for months type {cur_m}, location {l}"))
    model_loc <- glmer(REPORT ~ M.YEAR + MONTH:NO.SP + MONTH:M.YEAR + SP.CATEGORY +
                          (1|COMMON.NAME),
                        data = data_loc, family = binomial(link = "cloglog"),
                        nAGQ = 0, control = glmerControl(optimizer = "bobyqa"))
    tictoc::toc() 
    
    tictoc::tic(glue("Bootstrapped predictions for months type {cur_m}, location {l}"))
    prediction <- split_par_boot(model = model_loc, 
                                 new_data = prolific_pred0, 
                                 new_data_string = "prolific_pred0", 
                                 mode = "normal")
    tictoc::toc()

    for (i in 1:n_distinct(prolific_pred0$MONTH)) {
      
      for (j in 1:n_distinct(prolific_pred0$M.YEAR)) {
        
        for (k in 1:n_distinct(prolific_pred0$SP.CATEGORY)) {
          
          count <- count + 1

          prolific_pred0$PRED.LINK2[count] = median(na.omit(prediction[,count]))
          prolific_pred0$SE.LINK2[count] = sd(na.omit(prediction[,count]))
          
        }
      }
    }
  
  }
  
  prolific_pred <- prolific_pred %>% 
    left_join(prolific_pred0) %>% 
    mutate(PRED.LINK = coalesce(PRED.LINK, PRED.LINK2),
           SE.LINK = coalesce(SE.LINK, SE.LINK2)) %>% 
    dplyr::select(-PRED.LINK2, -SE.LINK2)

}



# for data points
prolific_points <- prolific_pred %>% 
  mutate(PRED = clogloglink(PRED.LINK, inverse = T),
         # to transform lower bound of SE (not CI.L! think "mean +- SE")
         SE.L = clogloglink((PRED.LINK - SE.LINK), inverse = T)) %>% 
  mutate(SE = PRED - SE.L) %>% 
  left_join(timeline) %>% 
  # averaging across months of year
  group_by(MONTHS.TYPE, M.YEAR, SP.CATEGORY, LOCALITY.ID) %>% 
  dplyr::summarise(PRED = mean(PRED),
            # propagating SE across species of a category
            SE = sqrt(sum((SE)^2))/n()) %>% 
  # to make lines connect per location                      
  group_by(MONTHS.TYPE, LOCALITY.ID, SP.CATEGORY) %>% 
  arrange(MONTHS.TYPE, LOCALITY.ID, SP.CATEGORY, M.YEAR) %>% 
  mutate(PATH.GROUP = glue("{LOCALITY.ID}{SP.CATEGORY}"))

prolific_pred <- prolific_points %>% 
  # summarising for species categories
  group_by(MONTHS.TYPE, M.YEAR, SP.CATEGORY) %>% 
  dplyr::summarise(PRED = mean(PRED),
            # propagating SE across species of a category
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PRED - 1.96*SE,
            CI.U = PRED + 1.96*SE)



# graphs ------------------------------------------------------------

save(prolific_pred, prolific_points, 
     file = glue("outputs/{anal_name}.RData"))

prolific_plot <- gg_b_model(prolific_pred, type = "prolific", prolific_points)

ggsave(filename = glue("03_wrap_figs/{anal_name}.png"), plot = prolific_plot,
       dpi = 300, width = 21, height = 6, units = "in")

```

The prolific birder patterns will be able to suggest something about change in detectability vs. new birds in the area. When models are run for each location and species included in the model, a bit difficult to interpret because of our migratory year classification. Only two months in 2019 (Apr, May) were affected by COVID, so if pattern in MY 2019 is different from that in MY 2020, difficult to determine which to consider as the COVID effect. However, on including a third graph of all ten months other than the COVID months, this becomes easier to ascertain. Need to run the model separately for the three time periods because the results from both are greatly different. Because we know that the time periods are different in such a way, we should not ignore this and let the single global model average out and skew the existing patterns.

There is no overall pattern or directionality in changes during the pandemic months of years. There is considerable variation between the patches in how reporting changed from year to year, especially during the peak months: while some increased in MY 2019, others decreased. In the other ten months of the year, nothing changed with the pandemic at all. In conclusion, it seems that the pandemic-induced changes were restricted to the lockdown months, but also there is no clear directionality in the changes over different locations and regions across the country.

Speculation: in some patches where reporting frequencies increased in MY 2019 then went back to normal, it could be due to lower noise levels inducing better detection.
