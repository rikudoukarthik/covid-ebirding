---
title: "COVID eBirding: Analyses"
date: "2022/05/02"
author: "Karthik Thrikkadeeri"
editor_options: 
  chunk_output_type: console
bibliography: covid-ebirding.bib
link-citations: yes
output: 
  html_document:
    toc: true
    toc_depth: 3  
    number_sections: false  
    theme: united  
    highlight: tango  # specifies the syntax highlighting style
---

```{r setup, include=FALSE}

library(tidyverse)
library(lubridate)
library(patchwork)
library(boot)
library(lme4)

theme_set(theme_bw())


timeline <- data0_MY_slice_G %>% distinct(COVID, YEAR, MONTH, M.YEAR)

covid_palette <- c("#1B9E77", "#E89005", "#EF4050", "#9678B6")
# covid_palette2 <- c("#1B9E77", "#D95F02", "#7570B3", "#555555")
covid_palette3 <- c("#1B9E77", "#E89005", "#9678B6")


anal_states <- data.frame(a = "Karnataka",
                          b = "Kerala",
                          c = "Maharashtra",
                          d = "Assam")


# boundary of India 
india <- rgdal::readOGR(dsn = "data/in_2011", layer = "India_2011")
sp::proj4string(india) <- "+proj=longlat +datum=WGS84"
india <- terra::vect(india)
# state boundaries
states <- rgdal::readOGR(dsn = "data/in_states_2019", layer = "in_states_2019") %>% 
  terra::vect()



knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, 
                      messages = FALSE, cache.lazy = FALSE)

```

```{r data, cache=TRUE}

source("scripts/functions.R")

# Only needed once in the beginning to obtain the data.
#
# # Getting MODIS data ###
# getmodisdata()
#
# Getting EBD data + filtering and preparing for current use (13 mins on server) ###
# tictoc::tic("Preparing data for analyses")
# datapath <- "data/ebd_IN_relMay-2022.RData"
# groupaccspath <- "data/ebd_users_GA_relMay-2022.csv"
# covidclasspath <- "data/covid_classification.csv"
# rast_UNU_path <- "data/rast_UNU.RData"
# rast_SoIB_path <- "data/rast_SoIB.RData"
# 
# data_qualfilt_prep(datapath, groupaccspath, covidclasspath,
#                    rast_UNU_path, rast_SoIB_path,
#                    maxvel = 20, minsut = 2)
# tictoc::toc()

load("data/data0_MY_slice.RData")

```


# Introduction

This study will focus on the impacts of the COVID-19 pandemic on both birds and the birding community in the Indian context. It will also try to understand the consequences of these changes on citizen science and the inferences that can be drawn from it. Lastly, it will propose guidelines for making the most of the available data while accounting for pandemic-driven biases and deviations from the pre-COVID normal. 

To ensure a balanced time frame, this study will focus on the years from 2018 to 2021. The time period of 2019--20 will be considered as “pre-COVID” while 2020--21 will be considered “COVID”. In order to account for within-year variations in bird and birder behaviour, the comparisons will be made on the month level. For instance, various metrics of birding behaviour in the month of June will be compared between 2018--19 and 2020--21, and will not be confounded with patterns seen in other months. 

***This notebook is the almost-final analysis notebook for the study. Here, following the interesting patterns/metrics discovered in 02_explor, I explore whether or not bird detectability has changed. I also build statistical models to prove that the patterns found in 02_explor are scientifically robust.***

## Questions

Are there any changes and gaps in the pandemic eBird data? These questions will be answered using numerous metrics calculated from the focal data point in eBird data, a checklist.

- What has happened to overall birding activity? 

  Overall birding activity has increased.

- What has happened to group birding? Has it decreased, as would be expected?

  Group birding decreased as expected.

- Has birding effort changed with the pandemic? 

  Birding effort has not decreased with the pandemic. 

- Are there biases in the pandemic birding activity in terms of spatial and temporal spread?

  There do not seem to be many large spatial or temporal biases in pandemic birding activity.
  
  
  
- Has there been a change in detectability of certain common urban birds during the pandemic?

- Is this change due to the behavioural changes in birdwatchers (such as increased urban birding) in 2020, especially around the months of Mar--May, or did detectability of birds truly increase?


# Birder behaviour (focus level: checklists)

Changes in eBirder behaviour will be analysed using the focal data point, checklists. A number of metrics based on checklists will be calculated and analysed (**at the monthly scale**), such as:

1. Number of submitted checklists  
    1. Total lists  
    1. Shared lists (use no. of obs.)  
1. Number of submitted checklists per observer  
    1. Total lists  
    1. Shared lists (use no. of obs.)  
1. Hotspot birding  
1. Birding protocol  
1. Birding distance
1. Site fidelity per observer  
1. Habitats surveyed  
1. Spatial spread of birding activity. These spatial patterns will be explored at two scales too: nationwide and regional.  
    1. Spatial spread by absences  
    1. Spatial spread by densities  
1. List duration
1. List length  
1. Birding time per observer (monthly for prelim, later maybe daily)  
1. Temporal spread of birding activity  
    1. Temporal spread within day (time-of-day)  
    1. Temporal spread within week (day-of-week)  
1. Media  
1. Number of new birders

When running the actual models, observer will be used as a random effect because all of these metrics would vary differently from observer to observer.

Post-presentation: regarding averaging national level patterns by state for some metrics, this means that means are manually calculated for states and the points plotted in the graph are only these single points per state (instead of all the raw data points).

GLMMs for birder behaviour run only for the following metrics:

- Group birding per observer 
- Site fidelity per observer 
- Birding time per observer 
- Hotspot birding 
- Birding protocol 
- Birding distance 
- List duration 
- List length 
- Proportion of urban birding 
- Spatial coverage 
- Spatial spread 
- Temporal spread 

### Group birding (>2 observer) per observer

```{r no_lists_po, cache=TRUE, message=FALSE}

##### Change in group birding per observer ####

temp1 <- data0_MY_slice_S %>% 
  group_by(COVID, M.YEAR, MONTH, STATE, OBSERVER.ID) %>% 
  dplyr::summarise(NO.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  ungroup() 

temp2 <- data0_MY_slice_S %>% 
  filter(NUMBER.OBSERVERS > 2) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE, OBSERVER.ID) %>% 
  dplyr::summarise(NO.SLISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  ungroup()

# this is for each observer, but we are interested in plotting mean value of all observers combined
# hence, averaging proportions and its SE by propagation of error

nl_po_sw <- temp1 %>% 
  left_join(temp2) %>% 
  mutate(NO.SLISTS = replace_na(NO.SLISTS, 0)) %>% 
  mutate(PROP.SLISTS = NO.SLISTS/NO.LISTS,
         SE = sqrt((PROP.SLISTS)*(1 - PROP.SLISTS)/NO.LISTS)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(PROP.SLISTS = mean(PROP.SLISTS),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PROP.SLISTS - 1.96*SE,
            CI.U = PROP.SLISTS + 1.96*SE)

nl_po_nw <- nl_po_sw %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(PROP.SLISTS = mean(PROP.SLISTS),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PROP.SLISTS - 1.96*SE,
            CI.U = PROP.SLISTS + 1.96*SE)


(ggplot(nl_po_nw, aes(MONTH, PROP.SLISTS, colour = COVID)) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "National level",
       x = "Month", y = "Group birding proportion")) /
((ggplot(filter(nl_po_sw, STATE == "Kerala"), 
       aes(MONTH, PROP.SLISTS, colour = COVID)) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Kerala",
       x = "Month", y = "Group birding proportion")) |
(ggplot(filter(nl_po_sw, STATE == "Karnataka"), 
       aes(MONTH, PROP.SLISTS, colour = COVID)) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Karnataka",
       x = "Month", y = "Group birding proportion"))) /
((ggplot(filter(nl_po_sw, STATE == "Maharashtra"), 
       aes(MONTH, PROP.SLISTS, colour = COVID)) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Maharashtra",
       x = "Month", y = "Group birding proportion")) |
(ggplot(filter(nl_po_sw, STATE == "Assam"), 
       aes(MONTH, PROP.SLISTS, colour = COVID)) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Assam",
       x = "Month", y = "Group birding proportion"))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in proportion of group birding per observer with the pandemic",
                subtitle = "Y-axis shows proportion of observers' checklists that are group birding events") -> no_lists_po

no_lists_po # plot

ggsave("03_wrap_figs/01_no_lists_po.png", plot = no_lists_po,
       width = 9, height = 9, units = "in")

rm(list = c("nl_po_sw","nl_po_nw","no_lists_po"))

##### Final analysis: statewise GLMMs of group birding per observer ####

### Karnataka

data_a <- data0_MY_slice_S %>% 
  filter(STATE == anal_states$a) %>% 
  group_by(M.YEAR, MONTH, OBSERVER.ID, SAMPLING.EVENT.IDENTIFIER) %>% 
  dplyr::summarise(GROUP.BIRDING = if_else(NUMBER.OBSERVERS > 2, 1, 0)) %>%
  ungroup() 

tictoc::tic("Group birding GLMM")
model_a <- glmer(GROUP.BIRDING ~ M.YEAR + M.YEAR:MONTH + (1|OBSERVER.ID),
                       data = data_a, family = binomial(link = "cloglog"),
                       nAGQ = 0, control = glmerControl(optimizer = "bobyqa")) 
tictoc::toc()


pred_a <- data_a %>% 
  tidyr::expand(nesting(MONTH, M.YEAR)) %>% 
  mutate(PROP.G.PRED = predict(model_a, data.frame(MONTH, M.YEAR),
                               type = "response", re.form = NA)) %>% 
  left_join(timeline)

ggplot(pred_a, aes(MONTH, PROP.G.PRED, colour = COVID)) +
  labs(title = anal_states$a,
       x = "Month", y = "Predicted group birding proportion") +
  geom_point(size = 3, position = position_dodge(0.5)) +
  # geom_errorbar(aes(ymin = CI.L, ymax = CI.U),
  #               size = 1.5, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette, name = "Period") 


### Kerala

data_b <- data0_MY_slice_S %>% 
  filter(STATE == anal_states$b) %>% 
  group_by(M.YEAR, MONTH, OBSERVER.ID, SAMPLING.EVENT.IDENTIFIER) %>% 
  dplyr::summarise(GROUP.BIRDING = if_else(NUMBER.OBSERVERS > 2, 1, 0)) %>%
  ungroup() 

tictoc::tic("Group birding GLMM")
model_b <- glmer(GROUP.BIRDING ~ M.YEAR + M.YEAR:MONTH + (1|OBSERVER.ID),
                       data = data_b, family = binomial(link = "cloglog"),
                       nAGQ = 0, control = glmerControl(optimizer = "bobyqa")) 
tictoc::toc()

pred_b <- data_b %>% 
  tidyr::expand(nesting(MONTH, M.YEAR)) %>% 
  mutate(PROP.G.PRED = predict(model_b, data.frame(MONTH, M.YEAR),
                               type = "response", re.form = NA)) %>% 
  left_join(timeline)

ggplot(pred_b, aes(MONTH, PROP.G.PRED, colour = COVID)) +
  labs(title = anal_states$b,
       x = "Month", y = "Predicted group birding proportion") +
  geom_point(size = 3, position = position_dodge(0.5)) +
  # geom_errorbar(aes(ymin = CI.L, ymax = CI.U),
  #               size = 1.5, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette, name = "Period") 


### Maharashtra

data_c <- data0_MY_slice_S %>% 
  filter(STATE == anal_states$c) %>% 
  group_by(M.YEAR, MONTH, OBSERVER.ID, SAMPLING.EVENT.IDENTIFIER) %>% 
  dplyr::summarise(GROUP.BIRDING = if_else(NUMBER.OBSERVERS > 2, 1, 0)) %>%
  ungroup() 

tictoc::tic("Group birding GLMM")
model_c <- glmer(GROUP.BIRDING ~ M.YEAR + M.YEAR:MONTH + (1|OBSERVER.ID),
                       data = data_c, family = binomial(link = "cloglog"),
                       nAGQ = 0, control = glmerControl(optimizer = "bobyqa")) 
tictoc::toc()

pred_c <- data_c %>% 
  tidyr::expand(nesting(MONTH, M.YEAR)) %>% 
  mutate(PROP.G.PRED = predict(model_c, data.frame(MONTH, M.YEAR),
                               type = "response", re.form = NA)) %>% 
  left_join(timeline)

ggplot(pred_c, aes(MONTH, PROP.G.PRED, colour = COVID)) +
  labs(title = anal_states$c,
       x = "Month", y = "Predicted group birding proportion") +
  geom_point(size = 3, position = position_dodge(0.5)) +
  # geom_errorbar(aes(ymin = CI.L, ymax = CI.U),
  #               size = 1.5, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette, name = "Period") 


### Assam

data_d <- data0_MY_slice_S %>% 
  filter(STATE == anal_states$d) %>% 
  group_by(M.YEAR, MONTH, OBSERVER.ID, SAMPLING.EVENT.IDENTIFIER) %>% 
  dplyr::summarise(GROUP.BIRDING = if_else(NUMBER.OBSERVERS > 2, 1, 0)) %>%
  ungroup() 

tictoc::tic("Group birding GLMM")
model_d <- glmer(GROUP.BIRDING ~ M.YEAR + M.YEAR:MONTH + (1|OBSERVER.ID),
                       data = data_d, family = binomial(link = "cloglog"),
                       nAGQ = 0, control = glmerControl(optimizer = "bobyqa")) 
tictoc::toc()

pred_d <- data_d %>% 
  tidyr::expand(nesting(MONTH, M.YEAR)) %>% 
  mutate(PROP.G.PRED = predict(model_d, data.frame(MONTH, M.YEAR),
                               type = "response", re.form = NA)) %>% 
  left_join(timeline)

ggplot(pred_d, aes(MONTH, PROP.G.PRED, colour = COVID)) +
  labs(title = anal_states$d,
       x = "Month", y = "Predicted group birding proportion") +
  geom_point(size = 3, position = position_dodge(0.5)) +
  # geom_errorbar(aes(ymin = CI.L, ymax = CI.U),
  #               size = 1.5, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette, name = "Period") 


```


### Site fidelity per observer  

```{r fidelity, cache=TRUE, message=FALSE}

# here, doing 24km x 24km (SoIB and also more lenient and appropriate)

set.seed(213) # for bootstrap
fidel_sw <- data0_MY_slice_S %>% 
  group_by(COVID, M.YEAR, MONTH, STATE, OBSERVER.ID) %>% 
  dplyr::summarise(NO.SITES = n_distinct(CELL.ID)) %>% 
  mutate(NO.SITES = replace_na(NO.SITES, 0)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(NO.SITES = boot_conf(x = NO.SITES)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(SE = sd(NO.SITES),
                   NO.SITES = mean(NO.SITES),
                   CI.L = NO.SITES - 1.96*SE,
                   CI.U = NO.SITES + 1.96*SE)

fidel_nw <- fidel_sw %>% 
  ungroup() %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(NO.SITES = mean(NO.SITES),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = NO.SITES - 1.96*SE,
            CI.U = NO.SITES + 1.96*SE)

  
(ggplot(fidel_nw, aes(MONTH, NO.SITES, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "No. of sites")) /
((ggplot(filter(fidel_sw, STATE == "Kerala"), 
         aes(MONTH, NO.SITES, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "No. of sites")) |
(ggplot(filter(fidel_sw, STATE == "Karnataka"), 
         aes(MONTH, NO.SITES, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "No. of sites"))) /
((ggplot(filter(fidel_sw, STATE == "Maharashtra"), 
         aes(MONTH, NO.SITES, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "No. of sites")) |
(ggplot(filter(fidel_sw, STATE == "Assam"), 
         aes(MONTH, NO.SITES, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Month", y = "No. of sites"))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in observer site fidelity with the pandemic",
subtitle = "Y-axis shows average number of unique sites (25kmx25km cells) visited by observers") -> fidelity

fidelity # plot

ggsave("03_wrap_figs/03_fidelity.png", plot = fidelity,
       width = 9, height = 9, units = "in")
  
rm(list = c("fidel_nw","fidel_sw","fidelity"))

```

* At the national level, site fidelity was generally higher during the pandemic than before but mostly only during lockdown/second wave. In other months there was no noticeable difference.    
* Among the four states compared, only Kerala and Karnataka showed this pattern, while in Gujarat and Maharashtra there seemed to be no difference with the pandemic at all.  

### Birding time per observer

```{r time, cache=TRUE, message=FALSE}

set.seed(423) 
time_sw <- data0_MY_slice_S %>% 
  group_by(COVID, M.YEAR, MONTH, STATE, OBSERVER.ID) %>% 
  dplyr::summarise(B.TIME = sum(DURATION.MINUTES)) %>% 
  mutate(B.TIME = replace_na(B.TIME, 0)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(B.TIME = boot_conf(x = B.TIME)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(SE = sd(B.TIME),
                   B.TIME = mean(B.TIME),
                   CI.L = B.TIME - 1.96*SE,
                   CI.U = B.TIME + 1.96*SE)

time_nw <- time_sw %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(B.TIME = mean(B.TIME),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = B.TIME - 1.96*SE,
            CI.U = B.TIME + 1.96*SE)


(ggplot(time_nw, aes(MONTH, B.TIME, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "National level",
       x = "Month", y = "Time (mins)")) /
((ggplot(filter(time_sw, STATE == "Kerala"), 
         aes(MONTH, B.TIME, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Kerala",
       x = "Month", y = "Time (mins)")) |
(ggplot(filter(time_sw, STATE == "Karnataka"), 
         aes(MONTH, B.TIME, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Karnataka",
       x = "Month", y = "Time (mins)"))) /
((ggplot(filter(time_sw, STATE == "Maharashtra"), 
         aes(MONTH, B.TIME, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Maharashtra",
       x = "Month", y = "Time (mins)")) |
(ggplot(filter(time_sw, STATE == "Assam"), 
         aes(MONTH, B.TIME, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Assam",
       x = "Month", y = "Time (mins)"))) +
plot_layout(guides = "collect") + 
plot_annotation(title = "Change in birding time per observer with the pandemic",
                subtitle = "Y-axis shows total birding times of observers") -> time

time # plot

ggsave("03_wrap_figs/04_time.png", plot = time,
       width = 9, height = 9, units = "in")

rm(time_nw, time_sw, time)

```

* At the national level, birding times were and are lowest during monsoon. There was no noticeable negative impact of the pandemic on monthly birding times, except in March 2020 when the pandemic was a novelty. In fact, in the monsoon months of July and August, birding times even increased slightly during the pandemic.  
* The only other major pattern visible at the state level is in Karnataka, where birding times have increased in the months of August--October.   

### Hotspot birding  

Not "per observer", as this metric from data POV. 

```{r hotspot, cache=TRUE, message=FALSE}

temp1 <- data0_MY_slice_G %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(NO.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  ungroup() 

temp2 <- data0_MY_slice_G %>% 
  filter(LOCALITY.TYPE == "H") %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(NO.HLISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  ungroup()

hot_sw <- temp1 %>% 
  left_join(temp2) %>% 
  mutate(NO.HLISTS = replace_na(NO.HLISTS, 0)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  mutate(PROP.HLISTS = NO.HLISTS/NO.LISTS,
         SE = sqrt((PROP.HLISTS)*(1 - PROP.HLISTS)/NO.LISTS),
         CI.L = PROP.HLISTS - 1.96*SE,
         CI.U = PROP.HLISTS + 1.96*SE) 

rm(list = c("temp1","temp2"))

hot_nw <- hot_sw %>%
  filter(NO.LISTS != 0) %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(PROP.HLISTS = mean(PROP.HLISTS),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PROP.HLISTS - 1.96*SE,
            CI.U = PROP.HLISTS + 1.96*SE) 


(ggplot(hot_nw, aes(MONTH, PROP.HLISTS, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "National level",
       x = "Month", y = "Hotspot birding proportion")) /
((ggplot(filter(hot_sw, STATE == "Kerala"),
         aes(MONTH, PROP.HLISTS, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Kerala",
       x = "Month", y = "Hotspot birding proportion")) |
(ggplot(filter(hot_sw, STATE == "Karnataka"),
         aes(MONTH, PROP.HLISTS, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Karnataka",
       x = "Month", y = "Hotspot birding proportion"))) /
((ggplot(filter(hot_sw, STATE == "Maharashtra"),
         aes(MONTH, PROP.HLISTS, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Maharashtra",
       x = "Month", y = "Hotspot birding proportion")) |
(ggplot(filter(hot_sw, STATE == "Assam"),
         aes(MONTH, PROP.HLISTS, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12) + 
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.4, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  labs(title = "Assam",
       x = "Month", y = "Hotspot birding proportion"))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in proportion of hotspot birding with the pandemic",
                subtitle = "Y-axis shows proportion of checklists that are from hotspots") -> hotspot

hotspot # plot

ggsave("03_wrap_figs/05_hotspot.png", plot = hotspot,
       width = 9, height = 9, units = "in")

rm(list = c("hot_nw","hot_sw", "hotspot"))

```

* The national level saw lower hotspot birding during the lockdown/second wave months, with some spillover into the months of June and July.  
* Kerala mirrored the national level pattern with slightly higher month-to-month variability.  
* In Karnataka, this impact surprisingly lasted through all of 2020 but returned almost exactly to pre-COVID levels in 2021.  
* Gujarat and Maharashtra basically mirror the national pattern.   

### Birding protocol  

Not "per observer", as this metric from data POV. 

```{r protocol, cache=TRUE, message=FALSE}

temp1 <- data0_MY_slice_G %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(NO.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  ungroup() 

temp2 <- data0_MY_slice_G %>% 
  filter(PROTOCOL.TYPE == "Traveling" & EFFORT.DISTANCE.KM >= 0.1) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(NO.TLISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  ungroup()

prot_sw <- temp1 %>% 
  left_join(temp2) %>% 
  mutate(NO.TLISTS = replace_na(NO.TLISTS, 0)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  mutate(PROP.TLISTS = NO.TLISTS/NO.LISTS,
         SE = sqrt((PROP.TLISTS)*(1 - PROP.TLISTS)/NO.LISTS),
         CI.L = PROP.TLISTS - 1.96*SE,
         CI.U = PROP.TLISTS + 1.96*SE) 

rm(list = c("temp1","temp2"))

prot_nw <- prot_sw %>%
  filter(NO.LISTS != 0) %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(PROP.TLISTS = mean(PROP.TLISTS),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PROP.TLISTS - 1.96*SE,
            CI.U = PROP.TLISTS + 1.96*SE) 


(ggplot(prot_nw, aes(MONTH, PROP.TLISTS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "Proportion of travelling lists")) /
((ggplot(filter(prot_sw, STATE == "Kerala"), 
         aes(MONTH, PROP.TLISTS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "Proportion of travelling lists")) |
(ggplot(filter(prot_sw, STATE == "Karnataka"), 
         aes(MONTH, PROP.TLISTS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
   geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "Proportion of travelling lists"))) /
((ggplot(filter(prot_sw, STATE == "Maharashtra"), 
         aes(MONTH, PROP.TLISTS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "Proportion of travelling lists")) |
(ggplot(filter(prot_sw, STATE == "Assam"), 
        aes(MONTH, PROP.TLISTS, colour = COVID)) + 
   scale_x_continuous(breaks = 1:12) + 
   geom_point(size = 3, position = position_dodge(0.5)) +
   geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                 size = 1.25, width = 0.4, position = position_dodge(0.5)) +
   scale_colour_manual(values = covid_palette) +
   labs(title = "Assam",
        x = "Month", y = "Proportion of travelling lists"))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in birding mobility with the pandemic",
                subtitle = "Y-axis shows proportion of checklists using the travelling protocol (>= 100m)") -> protocol

protocol 

ggsave("03_wrap_figs/06_protocol.png", plot = protocol,
       width = 9, height = 9, units = "in")

rm(list = c("prot_nw","prot_sw","protocol"))

```

* At the national level, mobility of birders, in terms of proportion of travelling lists submitted, decreased sharply during April--May as expected, and had some spillover into June and July, but matched pre-COVID levels well in the other months of the year.  
* In Kerala the pandemic has impacted all months of the year, except January and February which continue to have high proportions of travelling lists, possibly due mass birding events such as GBBC and AWC. Otherwise, even "after" the pandemic, mobility is much lower than before the pandemic.  
* Karnataka was mostly only affected during the months of March--May, with spillover into June and July. Moreover, this impact was only in 2020 and not 2021.  
* Gujarat and Maharashtra show high month-to-month variability but suggest somewhat similar patterns as at the national level.  

### Birding distance

Not "per observer", as this metric from data POV. Only considers travelling lists.

```{r distance, cache=TRUE, message=FALSE}

set.seed(192) 
dist_sw <- data0_MY_slice_G %>% 
  filter(PROTOCOL.TYPE == "Traveling", !is.na(EFFORT.DISTANCE.KM)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(DIST = boot_conf(x = EFFORT.DISTANCE.KM)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(SE = sd(DIST),
                   DIST = mean(DIST),
                   CI.L = DIST - 1.96*SE,
                   CI.U = DIST + 1.96*SE)

dist_nw <- dist_sw %>% ungroup() %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(DIST = mean(DIST),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = DIST - 1.96*SE,
            CI.U = DIST + 1.96*SE)


(ggplot(dist_nw, aes(MONTH, DIST, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "Distance travelled (km)")) /
((ggplot(filter(dist_sw, STATE == "Kerala"), 
         aes(MONTH, DIST, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "Distance travelled (km)")) |
(ggplot(filter(dist_sw, STATE == "Karnataka"), 
         aes(MONTH, DIST, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "Distance travelled (km)"))) /
((ggplot(filter(dist_sw, STATE == "Maharashtra"), 
         aes(MONTH, DIST, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "Distance travelled (km)")) |
(ggplot(filter(dist_sw, STATE == "Assam"), 
         aes(MONTH, DIST, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Month", y = "Distance travelled (km)"))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in birding mobility with the pandemic",
                subtitle = "Y-axis shows average distance travelled in checklists using the travelling protocol") -> distance

distance

ggsave("03_wrap_figs/07_distance.png", plot = distance,
       width = 9, height = 9, units = "in")

rm(dist_sw, dist_nw, distance)

```

* At the national level, checklist distances were highest during summer and winter before the pandemic. During the pandemic, distances remained fairly similar for the winter months of October--December, but were drastically lower during the summer months of April and May, which coincided with the lockdown/second wave.  
* In Kerala, before the pandemic, birders travelled longest in checklists during late summer and early winter and shortest in late winter and peak monsoon. This contrasts with the pattern seen in proportion of stationary lists (more stationary in early winter and less in late winter). This means that in early winter the lists were either stationary or travelling larger distances, while in late winter lists converged to shorter distances. With the pandemic, effort distances reduced in late summer and early monsoon, coinciding with the lockdown/second wave.  
* Karnataka showed small decreases in the months of April--June.  
* In Gujarat, interestingly, there is no difference with the pandemic except in the month of April.  
* Maharashtra seemed to very marginally affected by the pandemic, in terms of birding mobility. 


### List duration

Not "per observer", as this metric from data POV. 

```{r duration, cache=TRUE, message=FALSE}

set.seed(834)
dur_sw <- data0_MY_slice_G %>% 
  filter(!is.na(DURATION.MINUTES)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(DURATION = boot_conf(x = DURATION.MINUTES)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(SE = sd(DURATION),
                   DURATION = mean(DURATION),
                   CI.L = DURATION - 1.96*SE,
                   CI.U = DURATION + 1.96*SE)

dur_nw <- dur_sw %>% 
  ungroup() %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(DURATION = mean(DURATION),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = DURATION - 1.96*SE,
            CI.U = DURATION + 1.96*SE)


(ggplot(dur_nw, aes(MONTH, DURATION, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "Duration (mins)")) /
((ggplot(filter(dur_sw, STATE == "Kerala"), 
         aes(MONTH, DURATION, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "Duration (mins)")) |
(ggplot(filter(dur_sw, STATE == "Karnataka"), 
         aes(MONTH, DURATION, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "Duration (mins)"))) /
((ggplot(filter(dur_sw, STATE == "Maharashtra"), 
         aes(MONTH, DURATION, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "Duration (mins)")) |
(ggplot(filter(dur_sw, STATE == "Assam"), 
         aes(MONTH, DURATION, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Month", y = "Duration (mins)"))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in checklist duration with the pandemic",
                subtitle = "Y-axis shows average duration of checklists") -> duration

duration

ggsave("03_wrap_figs/08_duration.png", plot = duration,
       width = 9, height = 9, units = "in")

rm(dur_sw, dur_nw, duration)

```

* In normal circumstances, checklists become longer in the winter, and shorter in the monsoon. The only notable change during the pandemic at the national level was low checklist duration in April--June, due to the national lockdown/second wave.  
* In Kerala, while most of the pattern remains similar before and during the pandemic, the strong dip in checklist duration during the national lockdown is still present. Moreover, the winter month of January during the pandemic saw longer checklists than before.   
* Karnataka doesn't show very clear patterns apart from a possibly lower participation in the February GBBC (leading to higher average duration) during the pandemic, and shorter lists in April--May.  
* Gujarat and Maharashtra were mostly affected only in the March--May period.  
* A point of interest is that the average checklist duration varied greatly between states. Among the 4 compared here, Kerala on average had shortest lists, followed by Karnataka and then Maharashtra.  

### List length

Not "per observer", as this metric from data POV. 

```{r length, cache=TRUE, message=FALSE}

# var(mean(x))/var(median(x)) = 4n/(pi*(2n + 1))

# used mean here because it was proving extremely difficult to work with errors in the case of median

set.seed(98)
length_sw <- data0_MY_slice_G %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(LENGTH = boot_conf(x = NO.SP)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(SE = sd(LENGTH),
                   LENGTH = mean(LENGTH),
                   CI.L = LENGTH - 1.96*SE,
                   CI.U = LENGTH + 1.96*SE)

length_nw <- length_sw %>% 
  ungroup() %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(LENGTH = mean(LENGTH),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = LENGTH - 1.96*SE,
            CI.U = LENGTH + 1.96*SE)


(ggplot(length_nw, aes(MONTH, LENGTH, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "List length")) /
((ggplot(filter(length_sw, STATE == "Kerala"), 
         aes(MONTH, LENGTH, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "List length")) |
(ggplot(filter(length_sw, STATE == "Karnataka"), 
         aes(MONTH, LENGTH, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "List length"))) /
((ggplot(filter(length_sw, STATE == "Maharashtra"), 
         aes(MONTH, LENGTH, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "List length")) |
(ggplot(filter(length_sw, STATE == "Assam"), 
         aes(MONTH, LENGTH, colour = COVID)) + 
    scale_y_log10() + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Month", y = "List length"))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in checklist length with the pandemic",
                subtitle = "Y-axis shows average number of species recorded in checklists (list length)") -> length

length

ggsave("03_wrap_figs/09_length.png", plot = length,
       width = 9, height = 9, units = "in")

rm(length_nw, length_sw, length)

```

* At the national level, list length decreased only in April--May. Over all years, the average checklist becomes bigger in the winter (due to winter migrants adding to the local species pool).  
* In Kerala, list length increased in the winter months of December--January during the pandemic, but otherwise mirrored national patterns.  
* Other states mirrored national patterns with more or less degree of variablity.  

### Spatial spread and coverage 

1. Urban:non-urban ratio in birding effort 
    - Proportion of lists urban
    - Proportion of birded cells urban
2. Spatial coverage
    - Proportion of total cells in country/state covered across months
    - Proportions of total urban and non-urban cells in country/state covered across months
3. Spatial spread/evenness (24kmx24km cells; across 7 months)
    Large spatial and temporal scale---no STATE or MONTH/M.YEAR in question.
    - Averaged monthly proportional change in no. of lists per 24x24 cell 
    - Averaged monthly proportional change in no. of lists per 2x2 UNU cell averaged across 24x24 cell, for urban and non-urban separately.
    - Averaged monthly urban:non-urban ratio in no. of lists per 24x24 cell 

```{r s_UNU, cache=TRUE, message=FALSE}

##### Proportion of urban lists per grid cell ####

temp <- data0_MY_slice_G %>% 
  group_by(COVID, M.YEAR, MONTH, CELL.ID) %>% # state is meaningless cos CELL.ID
  filter(URBAN == 1) %>% 
  dplyr::summarise(U.LISTS = n_distinct(GROUP.ID)) %>% 
  ungroup()

urban_lists <- data0_MY_slice_G %>% 
  group_by(COVID, M.YEAR, MONTH, CELL.ID) %>%
  dplyr::summarise(TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(temp) %>% 
  group_by(COVID, M.YEAR, MONTH, CELL.ID) %>%
  dplyr::summarise(U.LISTS = replace_na(U.LISTS, 0),
                   PROP.U = U.LISTS/TOT.LISTS,
                   SE = sqrt((PROP.U)*(1 - PROP.U)/TOT.LISTS)) %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(PROP.U = mean(PROP.U),
                   SE = sqrt(sum((SE)^2))/n(),
                   CI.L = PROP.U - 1.96*SE,
                   CI.U = PROP.U + 1.96*SE)

rm(temp)


ggplot(urban_lists, aes(MONTH, PROP.U, colour = COVID)) + 
  scale_x_continuous(breaks = 1:12,
                     labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", 
                                "Sep", "Oct", "Nov", "Dec")) + 
  annotate("rect", xmin = 2.5, xmax = 9.5, ymin = -Inf, ymax = Inf, 
            fill = "#E0DDE3", col = NA, alpha = 0.5) +
  geom_point(size = 4, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.75, width = 0.7, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette,
                      name = "Period", 
                      labels = c("Before", "During (2020)", "During (2021)", "After")) +
  labs(title = "2020 lockdown restricted birders to urban areas",
       x = "Month", y = "Proportion of urban lists per grid cell") -> s_UNU

s_UNU


ggsave("03_wrap_figs/10a_s_UNU.png", 
       plot = s_UNU,
       width = 13, height = 7, units = "in")


##### Final analysis: GLMM of urban birding using weighted proportions ####

# https://github.com/lme4/lme4/issues/281
# Issue with high number of zeroes (or hence low proportion values) and back-transformation of linear variable without accounting for random variation
# So, need to include random effects in prediction.

require(lme4)
load("data/data0_MY_slice.RData")

data_urban <- data0_MY_slice_G %>% 
  group_by(M.YEAR, MONTH, COUNTY, CELL.ID) %>% 
  filter(URBAN == 1) %>% 
  dplyr::summarise(U.LISTS = n_distinct(GROUP.ID)) %>% 
  right_join(data0_MY_slice_G) %>% 
  group_by(M.YEAR, MONTH, COUNTY, CELL.ID) %>% 
  dplyr::summarise(TOT.LISTS = n_distinct(GROUP.ID),
                   U.LISTS = replace_na(min(U.LISTS), 0),
                   PROP.U = round(U.LISTS/TOT.LISTS, 4)) %>% 
  ungroup()
  
counties <- data_urban %>% distinct(COUNTY, CELL.ID)

# no MONTH main effect unlike in birds model
tictoc::tic("UNU GLMM using weighted proportions")
model_urban <- glmer(PROP.U ~ M.YEAR + M.YEAR:MONTH + (1|COUNTY/CELL.ID), 
                      weights = TOT.LISTS,
                      data = data_urban, family = binomial(link = "cloglog"),
                      nAGQ = 0, control = glmerControl(optimizer = "bobyqa")) # 119 sec
tictoc::toc()

# dataframe with empty column to populate with looped values
# total rows: product of distinct values of predictors
urban1 <- data_urban %>% 
  tidyr::expand(nesting(MONTH, M.YEAR, COUNTY, CELL.ID)) %>% 
  filter(!is.na(COUNTY)) %>% 
  mutate(PROP.U.PRED = predict(model_urban, data.frame(MONTH, M.YEAR, COUNTY, CELL.ID),
                               type = "response")) %>% 
  group_by(M.YEAR, MONTH) %>% 
  summarise(SE = sd(PROP.U.PRED)/sqrt(n()),
            PROP.U.PRED = mean(PROP.U.PRED)) %>% 
  summarise(PROP.U.PRED = mean(PROP.U.PRED),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PROP.U.PRED - 1.96*SE,
            CI.U = PROP.U.PRED + 1.96*SE)

urban2 <- data_urban %>% 
  tidyr::expand(nesting(MONTH, M.YEAR, COUNTY, CELL.ID)) %>% 
  filter(!is.na(COUNTY)) %>% 
  mutate(PROP.U.PRED = predict(model_urban, data.frame(MONTH, M.YEAR, COUNTY, CELL.ID),
                               type = "response")) %>% 
  filter(MONTH %in% 4:5) %>% 
  group_by(M.YEAR, MONTH) %>% 
  summarise(SE = sd(PROP.U.PRED)/sqrt(n()),
            PROP.U.PRED = mean(PROP.U.PRED)) %>% 
  summarise(PROP.U.PRED = mean(PROP.U.PRED),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PROP.U.PRED - 1.96*SE,
            CI.U = PROP.U.PRED + 1.96*SE)


ggplot(urban2, aes(M.YEAR, PROP.U.PRED)) +
    labs(title = "For the months of April and May",
         x = "Migratory year", y = "Predicted urban birding proportion") +
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U),
                  size = 1.5, width = 0.2, position = position_dodge(0.5))

ggplot(urban1, aes(M.YEAR, PROP.U.PRED)) +
    labs(title = "For all months",
         x = "Migratory year", y = "Predicted urban birding proportion") +
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U),
                  size = 1.5, width = 0.2, position = position_dodge(0.5))


```

```{r s_cover, cache=TRUE, message=FALSE}

##### Proportion of total grid cells covered ####

cover_sw <- data0_MY_slice_G %>% 
  group_by(STATE) %>% 
  mutate(TOT.CELLS = n_distinct(CELL.ID)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE, CELL.ID) %>% 
  dplyr::summarise(TOT.CELLS = min(TOT.CELLS),
                   N.LISTS = n_distinct(GROUP.ID)) %>% 
  filter(N.LISTS >= 10) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(TOT.CELLS = min(TOT.CELLS),
                   NO.CELLS = n_distinct(CELL.ID),
                   PROP.CELLS = NO.CELLS/TOT.CELLS,
                   SE = sqrt((PROP.CELLS)*(1 - PROP.CELLS)/TOT.CELLS),
                   CI.L = PROP.CELLS - 1.96*SE,
                   CI.U = PROP.CELLS + 1.96*SE)

cover_nw <- data0_MY_slice_G %>% 
  ungroup() %>% 
  mutate(TOT.CELLS = n_distinct(CELL.ID)) %>% 
  group_by(COVID, M.YEAR, MONTH, CELL.ID) %>% 
  dplyr::summarise(TOT.CELLS = min(TOT.CELLS),
                   N.LISTS = n_distinct(GROUP.ID)) %>% 
  filter(N.LISTS >= 10) %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(TOT.CELLS = min(TOT.CELLS),
                   NO.CELLS = n_distinct(CELL.ID),
                   PROP.CELLS = NO.CELLS/TOT.CELLS,
                   SE = sqrt((PROP.CELLS)*(1 - PROP.CELLS)/TOT.CELLS),
                   CI.L = PROP.CELLS - 1.96*SE,
                   CI.U = PROP.CELLS + 1.96*SE)


((ggplot(cover_nw, aes(MONTH, PROP.CELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "Birded proportion")) /
((ggplot(filter(cover_sw, STATE == "Kerala"), 
        aes(MONTH, PROP.CELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "Birded proportion")) |
(ggplot(filter(cover_sw, STATE == "Karnataka"), 
        aes(MONTH, PROP.CELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "Birded proportion"))) /
((ggplot(filter(cover_sw, STATE == "Maharashtra"), 
        aes(MONTH, PROP.CELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "Birded proportion")) |
(ggplot(filter(cover_sw, STATE == "Assam"), 
        aes(MONTH, PROP.CELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Month", y = "Birded proportion")))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in spatial coverage of monthly birding with the pandemic",
         subtitle = "Proportion of total grid cells (24kmx24km) having birding activity") -> s_cover

s_cover

ggsave("03_wrap_figs/11a_s_cover.png", 
       plot = s_cover,
       width = 9, height = 9, units = "in")


rm(cover_sw, cover_nw, s_cover)


##### Proportion of total urban cells & non-urban cells covered ####

temp1 <- data0_MY_slice_G %>% 
  group_by(STATE, URBAN) %>% 
  mutate(TOT.SUBCELLS = n_distinct(SUBCELL.ID)) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE, URBAN, SUBCELL.ID) %>% 
  dplyr::summarise(TOT.SUBCELLS = min(TOT.SUBCELLS),
                   N.LISTS = n_distinct(GROUP.ID)) %>% 
  filter(N.LISTS >= 1) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE, URBAN) %>% 
  dplyr::summarise(TOT.SUBCELLS = min(TOT.SUBCELLS),
                   NO.SUBCELLS = n_distinct(SUBCELL.ID),
                   PROP.SUBCELLS = NO.SUBCELLS/TOT.SUBCELLS,
                   SE = sqrt((PROP.SUBCELLS)*(1 - PROP.SUBCELLS)/TOT.SUBCELLS),
                   CI.L = PROP.SUBCELLS - 1.96*SE,
                   CI.U = PROP.SUBCELLS + 1.96*SE)

temp2 <- data0_MY_slice_G %>% 
  ungroup() %>% 
  mutate(TOT.SUBCELLS = n_distinct(SUBCELL.ID)) %>% 
  group_by(COVID, M.YEAR, MONTH, URBAN, SUBCELL.ID) %>% 
  dplyr::summarise(TOT.SUBCELLS = min(TOT.SUBCELLS),
                   N.LISTS = n_distinct(GROUP.ID)) %>% 
  filter(N.LISTS >= 1) %>% 
  group_by(COVID, M.YEAR, MONTH, URBAN) %>% 
  dplyr::summarise(TOT.SUBCELLS = min(TOT.SUBCELLS),
                   NO.SUBCELLS = n_distinct(SUBCELL.ID),
                   PROP.SUBCELLS = NO.SUBCELLS/TOT.SUBCELLS,
                   SE = sqrt((PROP.SUBCELLS)*(1 - PROP.SUBCELLS)/TOT.SUBCELLS),
                   CI.L = PROP.SUBCELLS - 1.96*SE,
                   CI.U = PROP.SUBCELLS + 1.96*SE)


cover_U_sw <- temp1 %>% filter(URBAN == 1)
cover_U_nw <- temp2 %>% filter(URBAN == 1)

cover_NU_sw <- temp1 %>% filter(URBAN == 0)
cover_NU_nw <- temp2 %>% filter(URBAN == 0)


((ggplot(cover_U_nw, aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "Birded proportion")) /
((ggplot(filter(cover_U_sw, STATE == "Kerala"), 
        aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "Birded proportion")) |
(ggplot(filter(cover_U_sw, STATE == "Karnataka"), 
        aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "Birded proportion"))) /
((ggplot(filter(cover_U_sw, STATE == "Maharashtra"), 
        aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "Birded proportion")) |
(ggplot(filter(cover_U_sw, STATE == "Assam"), 
        aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Month", y = "Birded proportion")))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in spatial coverage of monthly birding with the pandemic",
         subtitle = "Proportion of total urban cells (2kmx2km) having birding activity") -> s_cover_U


((ggplot(cover_NU_nw, aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "Birded proportion")) /
((ggplot(filter(cover_NU_sw, STATE == "Kerala"), 
        aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "Birded proportion")) |
(ggplot(filter(cover_NU_sw, STATE == "Karnataka"), 
        aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "Birded proportion"))) /
((ggplot(filter(cover_NU_sw, STATE == "Maharashtra"), 
        aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "Birded proportion")) |
(ggplot(filter(cover_NU_sw, STATE == "Assam"), 
        aes(MONTH, PROP.SUBCELLS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Month", y = "Birded proportion")))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in spatial coverage of monthly birding with the pandemic",
         subtitle = "Proportion of total non-urban cells (2kmx2km) having birding activity") -> s_cover_NU


s_cover_U
s_cover_NU


ggsave("03_wrap_figs/11b_s_cover_U.png", 
       plot = s_cover_U,
       width = 9, height = 9, units = "in")

ggsave("03_wrap_figs/11b_s_cover_NU.png", 
       plot = s_cover_NU,
       width = 9, height = 9, units = "in")

rm(temp1, temp2, cover_U_sw, cover_U_nw, cover_NU_sw, cover_NU_nw, s_cover_U, s_cover_NU)


```

```{r s_spread, cache=TRUE, message=FALSE}

library(rasterVis)

# using 24kmx24km for better compatibility with the 2x2 UNU resolution (facilitating whole number aggregation/averaging)

load("data/rast_SoIB.RData")
load("data/rast_UNU.RData")

##### Change in birding effort (no. of lists) per grid cell (map)  ####

data_SoIBmap0 <- data0_MY_slice_G %>% 
  filter(MONTH %in% month_compar$MONTH) %>% 
  mutate(CELL.LONG = raster::xyFromCell(rast_SoIB, CELL.ID)[,"x"],
         CELL.LAT = raster::xyFromCell(rast_SoIB, CELL.ID)[,"y"]) %>%
  group_by(COVID, CELL.ID, CELL.LONG, CELL.LAT, MONTH) %>% 
  dplyr::summarise(NO.LISTS = n_distinct(GROUP.ID)) %>% 
  # summarise removes one grouping variable so no need to repeat group_by() 
  dplyr::summarise(NO.LISTS = mean(NO.LISTS)) %>% 
  ungroup()


temp0 <- data_SoIBmap0 %>% distinct(CELL.ID, CELL.LONG, CELL.LAT)


data_SoIBmap1 <- data_SoIBmap0 %>% 
  filter(COVID == "BEF") %>% 
  # to include all grid cells and not just those with birding in BEF
  right_join(temp0) %>% 
  mutate(COVID = "BEF", 
         NO.LISTS = replace_na(NO.LISTS, replace = 0)) %>% 
  dplyr::select(CELL.LONG, CELL.LAT, NO.LISTS)

rast_SoIBmap1 <- raster::rasterFromXYZ(xyz = data_SoIBmap1,
                                       crs = raster::crs(rast_SoIB))


data_SoIBmap2 <- data_SoIBmap0 %>% 
  filter(COVID %in% c("DUR_20","DUR_21")) %>% 
  group_by(CELL.ID, CELL.LONG, CELL.LAT) %>% 
  # averages cells with lists from both years, and returns single year value for others (n/1)
  dplyr::summarise(NO.LISTS = mean(NO.LISTS)) %>% 
  ungroup() %>% 
  right_join(temp0) %>% 
  mutate(COVID = "DUR", 
         NO.LISTS = replace_na(NO.LISTS, replace = 0)) %>% 
  dplyr::select(CELL.LONG, CELL.LAT, NO.LISTS)

rast_SoIBmap2 <- raster::rasterFromXYZ(xyz = data_SoIBmap2,
                                       crs = raster::crs(rast_SoIB))


data_SoIBmap3 <- data_SoIBmap0 %>% 
  filter(COVID == "AFT") %>% 
  right_join(temp0) %>% 
  mutate(COVID = "AFT", 
         NO.LISTS = replace_na(NO.LISTS, replace = 0)) %>% 
  dplyr::select(CELL.LONG, CELL.LAT, NO.LISTS)

rast_SoIBmap3 <- raster::rasterFromXYZ(xyz = data_SoIBmap3,
                                       crs = raster::crs(rast_SoIB))



rast_SoIBmap <- raster::stack(
  raster::overlay(x = rast_SoIBmap1, y = rast_SoIBmap2, 
                  k = 1, # constant to prevent NAs
                  fun = rast_logpropchange),
  raster::overlay(x = rast_SoIBmap2, y = rast_SoIBmap3, 
                  k = 1, 
                  fun = rast_logpropchange),
  raster::overlay(x = rast_SoIBmap1, y = rast_SoIBmap3, 
                  k = 1, 
                  fun = rast_logpropchange))
names(rast_SoIBmap) <- c("BeforeDuring", "DuringAfter", "BeforeAfter")



library(RColorBrewer)


in_bound <- rbind(india, states) %>% as("Spatial") # converting for sp::sp.polygons()

# for graph legends
plotfrom <- raster::cellStats(rast_SoIBmap, "min")[1]
plotto <- raster::cellStats(rast_SoIBmap, "max")[1]
plotlegend <- seq(round(plotfrom, 2), round(plotto, 2), 0.1)

labellegend <- data.frame(NORMAL = seq(exp(plotfrom), exp(plotto), length.out = 10)) %>% 
  mutate(LOG = log(NORMAL),
         LABEL = round(NORMAL, 1))


mytheme <- rasterVis::rasterTheme(region = viridis::viridis(100),
                                  box.rectangle = list(col = "white", fill = "black"),
                                  box.umbrella = list(col = 'black', lty = 1),
                                  panel.background = list(col = "#F0F0F0"),
                                  strip.background = list(col = "transparent"),
                                  strip.border = list(col = "transparent"))

levelplot(rast_SoIBmap, 
          par.settings = mytheme, 
          margin = F, 
          at = plotlegend,
          main = list(label = "Proportional change in monthly (seven months) no. of lists per 24km \u00d7 24km cell",
                      cex = 1.5),
          xlab = list(label = "Longitude", cex = 1.3),
          ylab = list(label = "Latitude", cex = 1.3),
          scales = list(cex = 1),
          names.attr = c("Before to During", "During to After"),
          par.strip.text = list(cex = 1.2),
          colorkey = list(labels = list(at = labellegend$LOG,
                                        labels = labellegend$LABEL))) +
  latticeExtra::layer(sp::sp.polygons(in_bound, alpha = 0.4)) -> s_spread_SoIBmap


png(file = "pics/03_presentation_IOC_map.png", 
    width = 16, height = 9, units = "in", res = 300)
print(s_spread_SoIBmap)
dev.off()


##### Final analysis: net change across grids with SEs ####

temp <- data0_MY_slice_G %>% 
  ungroup() %>% 
  filter(MONTH %in% month_compar$MONTH) %>% 
  group_by(COVID, CELL.ID, MONTH) %>% 
  dplyr::summarise(NO.LISTS = n_distinct(GROUP.ID)) %>% 
  # summarise removes one grouping variable so no need to repeat group_by() 
  dplyr::summarise(NO.LISTS = mean(NO.LISTS)) %>% 
  ungroup()

temp0 <- temp %>% distinct(CELL.ID)

temp1 <- temp %>% 
  filter(COVID == "BEF") %>% 
  # to include all grid cells and not just those with birding in BEF
  right_join(temp0) %>% 
  mutate(NO.LISTS = replace_na(NO.LISTS, replace = 0)) %>% 
  rename(BEF = NO.LISTS) %>% 
  dplyr::select(CELL.ID, BEF)

temp2 <- temp %>% 
  filter(COVID %in% c("DUR_20","DUR_21")) %>% 
  group_by(CELL.ID) %>% 
  # averages cells with lists from both years, and returns single year value for others (n/1)
  dplyr::summarise(NO.LISTS = mean(NO.LISTS)) %>% 
  ungroup() %>% 
  right_join(temp0) %>% 
  mutate(NO.LISTS = replace_na(NO.LISTS, replace = 0)) %>% 
  rename(DUR = NO.LISTS) %>% 
  dplyr::select(CELL.ID, DUR)

temp3 <- temp %>% 
  filter(COVID == "AFT") %>% 
  # to include all grid cells and not just those with birding in BEF
  right_join(temp0) %>% 
  mutate(NO.LISTS = replace_na(NO.LISTS, replace = 0)) %>% 
  rename(AFT = NO.LISTS) %>% 
  dplyr::select(CELL.ID, AFT)


set.seed(23) # for bootstrap
net_effort <- temp0 %>% 
  left_join(temp1) %>% 
  left_join(temp2) %>% 
  left_join(temp3) %>% 
  group_by(CELL.ID) %>% 
  dplyr::summarise(BeforeDuring = rast_propchange(BEF, DUR, k = 1),
                   DuringAfter = rast_propchange(DUR, AFT, k = 1)) %>% 
  pivot_longer(cols = c(BeforeDuring, DuringAfter),
               names_to = "PERIOD", 
               values_to = "PROP.CHANGE") %>%  # log. prop. change in monthly no.lists per 24x24
  group_by(PERIOD) %>% 
  # this gives B number of means/medians of bootstrapped samples
  # median resulting in just 1s so mean is fine
  dplyr::summarise(PROP.CHANGE = boot_conf(x = PROP.CHANGE)) %>% 
  group_by(PERIOD) %>% 
  dplyr::summarise(CI.L = stats::quantile(PROP.CHANGE, 0.025), # Obtain the CIs
                   CI.U = stats::quantile(PROP.CHANGE, 0.975),
                   PROP.CHANGE = mean(PROP.CHANGE))


rm(temp1, temp2, temp3, temp0, temp)

ggplot(net_effort, aes(x = PERIOD, y = PROP.CHANGE)) + 
  geom_point(size = 4, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.75, width = 0.08, position = position_dodge(0.5)) +
  scale_y_continuous(limits = c(1.1, 2.3), breaks = seq(1, 3, 0.2)) +
  scale_x_discrete(labels = c("Before to During", "During to After")) +
  labs(title = "Net proportional change in birding effort (no. of lists)",
       subtitle = "Change per 24kmx24km cell averaged across all cells with birding activity",
       x = "Period", y = "Proportional change") -> s_spread_netchange

s_spread_netchange

ggsave("03_wrap_figs/12d_s_spread_netchange.png", 
       plot = s_spread_netchange,
       dpi = 300, width = 6, height = 9, units = "in")


##### Removing workspace objects ####


rm(list = setdiff(ls(), 
                  c("covid_palette", "covid_palette3", "india", "states",
                    "data0_MY_slice_G", "data0_MY_slice_S", "month_compar",
                    "boot_conf", "rast_agg_fn", "rast_logpropchange",
                    "rast_propchange")))


detach("package:gdalUtils", unload=T)
detach("package:geodata", unload=T)
detach("package:raster", unload=T, force = T)
detach("package:terra", unload=T, force = T)
detach("package:luna", unload=T)



```


* Both the maps and the graphs show that there were overall more cells covered during the pandemic, and even more after. This can be attributed to general growth in eBirding.  
* Proportion of grid cells covered was impacted in both 2020 and 2021 in May, while in 2020 only in April.  
* SD of number of lists per cell was higher during the lockdown/second wave months, but otherwise not very different between the three periods.


### Temporal spread

Not "per observer", as this metric from data POV. 

Since month is not considered here (and instead data from multiple months are averaged), it doesn't make sense to keep two years for BEF and AFT---they should instead also be pooled into the averaging.

#### Day-of-week

```{r t_spread_1, cache=TRUE, message=FALSE}

t_dow_sw <- data0_MY_slice_G %>% 
  filter(MONTH %in% month_compar$MONTH) %>% 
  mutate(DAY.W = wday(OBSERVATION.DATE, 
                      week_start = getOption("lubridate.week.start", 1))) %>% 
  group_by(COVID, STATE, M.YEAR, MONTH) %>% 
  mutate(NO.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  group_by(COVID, DAY.W, STATE, M.YEAR, MONTH) %>% 
  dplyr::summarise(NO.LISTS = min(NO.LISTS),
                   DAY.LISTS = replace_na(n_distinct(SAMPLING.EVENT.IDENTIFIER)),
                   PROP.LISTS = DAY.LISTS/NO.LISTS,
                   SE = sqrt((PROP.LISTS)*(1 - PROP.LISTS)/NO.LISTS)) %>% 
  group_by(COVID, DAY.W, STATE) %>% 
  dplyr::summarise(PROP.LISTS = mean(PROP.LISTS),
                   SE = sqrt(sum((SE)^2))/n(),
                   CI.L = PROP.LISTS - 1.96*SE,
                   CI.U = PROP.LISTS + 1.96*SE)

t_dow_nw <- t_dow_sw %>% 
  group_by(COVID, DAY.W) %>% 
  dplyr::summarise(PROP.LISTS = mean(PROP.LISTS),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PROP.LISTS - 1.96*SE,
            CI.U = PROP.LISTS + 1.96*SE)

(ggplot(t_dow_nw, 
       aes(as.factor(DAY.W), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Day", y = "Proportion of lists")) /
((ggplot(filter(t_dow_sw, STATE == "Kerala"), 
         aes(as.factor(DAY.W), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Day", y = "Proportion of lists")) |
ggplot(filter(t_dow_sw, STATE == "Karnataka"), 
         aes(as.factor(DAY.W), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Day", y = "Proportion of lists")) /
((ggplot(filter(t_dow_sw, STATE == "Maharashtra"), 
         aes(as.factor(DAY.W), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Day", y = "Proportion of lists")) |
ggplot(filter(t_dow_sw, STATE == "Assam"), 
         aes(as.factor(DAY.W), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Day", y = "Proportion of lists")) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in temporal spread of checklists with the pandemic (September to March)",
                subtitle = "Y-axis shows average proportion of checklists from respective days of the week on X-axis") -> t_spread_dow

t_spread_dow

ggsave("03_wrap_figs/13_t_spread_dow.png", 
       plot = t_spread_dow,
       width = 9, height = 9, units = "in")


rm(t_dow_sw, t_dow_nw, t_spread_dow)

```

* At the national level, birding on Saturdays has decreased, and been balanced by more birding on Wednesdays, while Sunday birding seems to have also increased.  
* In Kerala, birding seems to have increased during Thursday--Saturday and decreased on Sunday.  
* In Karnataka there hasn't been much of a change with the pandemic, and there is still a heavy weekend bias in birding activity (Saturday and Sunday levels being similar).  
* In Gujarat and Maharashtra, Sundays see more birding than Saturdays, but there has been no major impact of the pandemic.  
* This might mean that the national level patterns might be driven by changes in states with generally low birding activity.  

#### Time-of-day

```{r t_spread_2, cache=TRUE, message=FALSE}

t_tod_sw <- data0_MY_slice_G %>% 
  filter(MONTH %in% month_compar$MONTH) %>% 
  group_by(COVID, STATE, M.YEAR, MONTH) %>% 
  mutate(NO.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  group_by(COVID, STATE, HOUR, M.YEAR, MONTH) %>% 
  dplyr::summarise(NO.LISTS = min(NO.LISTS),
                   TIME.LISTS = replace_na(n_distinct(SAMPLING.EVENT.IDENTIFIER)),
                   PROP.LISTS = TIME.LISTS/NO.LISTS,
                   SE = sqrt((PROP.LISTS)*(1 - PROP.LISTS)/NO.LISTS)) %>% 
  group_by(COVID, STATE, HOUR) %>% 
  dplyr::summarise(PROP.LISTS = mean(PROP.LISTS),
                   SE = sqrt(sum((SE)^2))/n(),
                   CI.L = PROP.LISTS - 1.96*SE,
                   CI.U = PROP.LISTS + 1.96*SE)

t_tod_nw <- t_tod_sw %>%
  group_by(COVID, HOUR) %>% 
  dplyr::summarise(PROP.LISTS = mean(PROP.LISTS),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PROP.LISTS - 1.96*SE,
            CI.U = PROP.LISTS + 1.96*SE)


(ggplot(t_tod_nw, 
       aes(as.factor(HOUR), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Time of day (hours)", y = "Proportion of lists")) /
((ggplot(filter(t_tod_sw, STATE == "Kerala"), 
         aes(as.factor(HOUR), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Time of day (hours)", y = "Proportion of lists")) |
ggplot(filter(t_tod_sw, STATE == "Karnataka"), 
         aes(as.factor(HOUR), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Time of day (hours)", y = "Proportion of lists")) /
((ggplot(filter(t_tod_sw, STATE == "Maharashtra"), 
         aes(as.factor(HOUR), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Time of day (hours)", y = "Proportion of lists")) |
ggplot(filter(t_tod_sw, STATE == "Assam"), 
         aes(as.factor(HOUR), PROP.LISTS, colour = COVID)) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Time of day (hours)", y = "Proportion of lists")) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in temporal spread of checklists with the pandemic (September to March)",
                subtitle = "Y-axis shows average proportion of checklists from respective times of the day on X-axis") -> t_spread_tod

t_spread_tod

ggsave("03_wrap_figs/14_t_spread_tod.png", 
       plot = t_spread_tod,
       width = 13, height = 9, units = "in")


rm(t_tod_nw, t_tod_sw, t_spread_tod)

```

* At the national level, there are two peaks in the day that see highest birding activity: early morning and evening.  
* In 2020, there was a sharp rise in birding activity at 17:00, and dip at 16:00.  
* In 2021, birding increased at 06:00 and 15:00, and decreased at 16:00.  
* The increase in evening birding was prominent in Karnataka, Gujarat and Maharashtra.

### Media

Not "per observer", as this metric from data POV. 

```{r media, cache=TRUE, message=FALSE}

temp1 <- data0_MY_slice_G %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(NO.LISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  ungroup() 

temp2 <- data0_MY_slice_G %>% 
  filter(HAS.MEDIA == 1) %>% 
  group_by(COVID, M.YEAR, MONTH, STATE) %>% 
  dplyr::summarise(NO.MLISTS = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>%
  ungroup()

media_sw <- temp1 %>% 
  left_join(temp2) %>% 
  mutate(NO.MLISTS = replace_na(NO.MLISTS, 0),
         PROP.MLISTS = NO.MLISTS/NO.LISTS,
         SE = sqrt((PROP.MLISTS)*(1 - PROP.MLISTS)/NO.LISTS),
         CI.L = PROP.MLISTS - 1.96*SE,
         CI.U = PROP.MLISTS + 1.96*SE) 

rm(list = c("temp1","temp2"))

media_nw <- media_sw %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  dplyr::summarise(PROP.MLISTS = mean(PROP.MLISTS),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = PROP.MLISTS - 1.96*SE,
            CI.U = PROP.MLISTS + 1.96*SE) 


(ggplot(media_nw, aes(MONTH, PROP.MLISTS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "Proportion of media lists")) /
((ggplot(filter(media_sw, STATE == "Kerala"), 
         aes(MONTH, PROP.MLISTS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "Proportion of media lists")) |
(ggplot(filter(media_sw, STATE == "Karnataka"), 
         aes(MONTH, PROP.MLISTS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "Proportion of media lists"))) /
((ggplot(filter(media_sw, STATE == "Maharashtra"), 
         aes(MONTH, PROP.MLISTS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "Proportion of media lists")) |
(ggplot(filter(media_sw, STATE == "Assam"), 
         aes(MONTH, PROP.MLISTS, colour = COVID)) + 
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Month", y = "Proportion of media lists"))) +
plot_layout(guides= "collect") +
plot_annotation(title = "Change in proportion of media lists with the pandemic",
                subtitle = "Y-axis shows proportion of checklists that contain uploaded media") -> media

media

ggsave("03_wrap_figs/15_media.png", plot = media,
       width = 9, height = 9, units = "in")

rm(list = c("media_nw","media_sw","media"))

```

* There is no major difference in proportion of media lists before, during and after the pandemic.  

### New birders

```{r new, cache=TRUE, message=FALSE}

load("data/new_obsr_data.RData")

# not new to the state, but new overall, just grouped by state of first eBirding
new_obsr_sw <- new_obsr_data %>% 
  group_by(COVID, LE.YEAR, LE.MONTH, STATE) %>% 
  dplyr::summarise(NEW = n_distinct(OBSERVER.ID)) %>% 
  ungroup()

set.seed(765)
new_obsr_nw <- new_obsr_sw %>% 
  group_by(COVID, LE.YEAR, LE.MONTH) %>% 
  dplyr::summarise(NEW = boot_conf(x = NEW)) %>% 
  group_by(COVID, LE.YEAR, LE.MONTH) %>% 
  dplyr::summarise(SE = sd(NEW),
                   NEW = mean(NEW),
                   CI.L = NEW - 1.96*SE,
                   CI.U = NEW + 1.96*SE)


(ggplot(new_obsr_nw, aes(LE.MONTH, NEW, colour = COVID)) + 
    scale_y_log10() +
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.25, width = 0.4, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "National level",
         x = "Month", y = "New eBirders")) /
((ggplot(filter(new_obsr_sw, STATE == "Kerala"), 
         aes(LE.MONTH, NEW, colour = COVID)) + 
    scale_y_log10() +
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Kerala",
         x = "Month", y = "New eBirders")) |
(ggplot(filter(new_obsr_sw, STATE == "Karnataka"), 
         aes(LE.MONTH, NEW, colour = COVID)) + 
    scale_y_log10() +
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Karnataka",
         x = "Month", y = "New eBirders"))) /
((ggplot(filter(new_obsr_sw, STATE == "Maharashtra"), 
         aes(LE.MONTH, NEW, colour = COVID)) + 
    scale_y_log10() +
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Maharashtra",
         x = "Month", y = "New eBirders")) |
(ggplot(filter(new_obsr_sw, STATE == "Assam"), 
         aes(LE.MONTH, NEW, colour = COVID)) + 
    scale_y_log10() +
    scale_x_continuous(breaks = 1:12) + 
    geom_point(size = 3, position = position_dodge(0.5)) +
    scale_colour_manual(values = covid_palette) +
    labs(title = "Assam",
         x = "Month", y = "New eBirders"))) +
plot_layout(guides = "collect") +
plot_annotation(title = "Change in eBirder growth with the pandemic",
                subtitle = "Y-axis shows average number of new eBirders") -> new

new # plot

ggsave("03_wrap_figs/16_new.png", plot = new,
       width = 9, height = 9, units = "in")


rm(list = c("new_obsr_nw","new_obsr_sw","new"))

```

* At the national level, the pandemic has seen a greater number of monthly new eBirders than before, presumably due to greater frequency and impact of outreach initiatives.  
* While Kerala and Karnataka both have seen increases in monthly new eBirders with the pandemic, the increase is more striking in Karnataka than in Kerala. 



# Bird behaviour 

Two sets of bird species will be selected, one of birds common in human-dominated areas, and the other of common birds that are not very common in human-dominated areas. Reporting frequencies of all species will be calculated for every month and year. If there is an increase during the Mar--May period of birds in the first set and a decrease of birds in the second set, this means that birdwatcher bias has affected bird abundance as seen from the data. 

```{r b_setup, cache=TRUE, message=FALSE}

load("data/data0_MY_slice.RData")
load("data/data0_MY.RData")


### bird species to analyse/compare ####

species <- data.frame(
  COMMON.NAME = c("House Crow", "Common Myna", "Jungle Myna", "Rock Pigeon", "Black Kite", "Common Tailorbird", "Rose-ringed Parakeet", "Asian Koel", "Purple Sunbird", "Pale-billed Flowerpecker", "White-cheeked Barbet", 
                  "Little Cormorant", "Gray-headed Swamphen", "Indian Pond-Heron",
                  "Green Bee-eater", "Black Drongo", "Pied Bushchat", "Plain Prinia", "Indian Robin", "House Sparrow", "Spotted Dove", "Coppersmith Barbet", "Black-winged Kite", "Small Minivet", "Long-tailed Shrike", "Gray Francolin"),
  SP.CATEGORY = c(rep("U", 11), rep("W", 3), rep("R", 12)))

# # check if common names are written correctly
# species$COMMON.NAME %in% data0$COMMON.NAME


# Guwahati lacks PBFl, WCBa (but BTBa), InRo, GrFr, PiBu, BWKi, GHSw (in good numbers)
# Ernakulam lacks GrFr, SmMi, BWKi, LTSh, PiBu (in good numbers)


# different from list for BLR and PUN because 5 non-urban species from that list do not occur in sufficient numbers in EKM
species_koch <- data.frame(
  COMMON.NAME = c("House Crow", "Common Myna", "Jungle Myna", "Rock Pigeon", "Black Kite", "Common Tailorbird", "Rose-ringed Parakeet", "Asian Koel", "Purple Sunbird", "Pale-billed Flowerpecker", "White-cheeked Barbet", 
                  "Little Cormorant", "Gray-headed Swamphen", "Indian Pond-Heron",
                  "Green Bee-eater", "Black Drongo", "Plain Prinia", "Indian Robin", "House Sparrow", "Spotted Dove", "Coppersmith Barbet", "White-throated Kingfisher", "Black-rumped Flameback", "Rufous Treepie"),
  SP.CATEGORY = c(rep("U", 11), rep("W", 3), rep("R", 10)))


species_guwa <- data.frame(
  COMMON.NAME = c("House Crow", "Common Myna", "Jungle Myna", "Rock Pigeon", "Black Kite", "Common Tailorbird", "Rose-ringed Parakeet", "Asian Koel", "Purple Sunbird", "Blue-throated Barbet",
                  "Little Cormorant", "Indian Pond-Heron",
                  "Green Bee-eater", "Black Drongo", "Plain Prinia", "House Sparrow", "Spotted Dove", "Coppersmith Barbet", "White-throated Kingfisher", "Black-rumped Flameback", "Rufous Treepie", "Long-tailed Shrike"),
  SP.CATEGORY = c(rep("U", 10), rep("W", 2), rep("R", 10)))


### choosing grid cells of 4 cities ####

# load("data/rast_SoIB.RData")
# 
# # poly_SoIB <- rast_SoIB %>% 
# #   raster::intersect(as(india, "Spatial")) %>%
# #   raster::projectRaster(crs = "EPSG:3857", method = "ngb") %>% 
# #   raster::rasterToPolygons() 
# # 
# poly_SoIB <- rast_SoIB %>%
#   raster::intersect(as(india, "Spatial")) %>%
#   raster::rasterToPolygons() %>%
#   sp::spTransform("+proj=longlat +init=EPSG:3857 +no_defs")
# 
# poly_SoIB <- rast_SoIB %>%
#   # raster::intersect(as(india, "Spatial")) %>%
#   raster::rasterToPolygons()
# 
# # because raster and poly do not align perfectly:
# # https://stackoverflow.com/questions/33742107/raster-image-seems-to-be-shifted-using-leaflet-for-r
# rast_SoIB2 <- rast_SoIB
# raster::nrow(rast_SoIB2) <- 600
# raster::ncol(rast_SoIB2) <- 600
# rast_SoIB3 <- raster::resample(rast_SoIB, rast_SoIB2, method = "ngb")
# 
# 
# library(leaflet)
# leafcols <- colorFactor(c(NA, "#0C2C84"), 
#                         raster::values(rast_SoIB),
#                         na.color = "#ffba00")
# leaflet() %>%
#   addTiles() %>% 
#   addPolygons(data = poly_SoIB, color = "#000000",
#               label = sp::getSpPPolygonsIDSlots(poly_SoIB)) %>%
#   addRasterImage(rast_SoIB3,
#                  method = "ngb", # nearest neighbour
#                  colors = leafcols,
#                  opacity = 0.7,
#                  maxBytes = 150 * 1024 * 1024) %>%
#   addLegend(pal = leafcols, values = raster::values(rast_SoIB3))

city_bang <- c(25545, 25722, 25723, 25899, 25900)
city_pune <- c(19681, 19682, 19859)
city_koch <- c(28900, 28901)
city_guwa <- c(11648, 11824, 11825)

# # verifying whether chosen "city" area includes most of birding activity in county
# data0_MY_slice_G %>% filter(COUNTY == "Kamrup Metropolitan") %>% n_distinct()
# data0_MY_slice_G %>% filter(COUNTY == "Kamrup Metropolitan", 
#                             CELL.ID %in% city_guwa) %>% n_distinct()

```


## Bengaluru Urban

```{r b_bang_01_monthly, cache=TRUE, message=FALSE}

birds_monthly <- data0_MY_slice_G %>% 
  filter(COUNTY == "Bangalore", CELL.ID %in% city_bang) %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  summarise(GROUP.ID = GROUP.ID, # not mutating so as to remove unwanted join columns
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species$COMMON.NAME) %>% 
  group_by(COMMON.NAME, COVID, M.YEAR, MONTH) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species)


((ggplot(filter(birds_monthly, SP.CATEGORY == "U"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "R"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "W"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Month", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Bengaluru city") -> b_bang_01_monthly


ggsave("03_wrap_figs/b_bang_01_monthly.png", b_bang_01_monthly,
       width = 11, height = 15, units = "in", dpi = 300)

```

Nothing conclusively due to the pandemic or in one particular direction. Do these slight patterns persist at the annual level (considering SoIB scale of migratory year)?

```{r b_bang_02_annual, cache=TRUE, message=FALSE}

birds <- data0_MY_slice_G %>% 
  filter(COUNTY == "Bangalore", CELL.ID %in% city_bang) %>% 
  group_by(M.YEAR, MONTH) %>% 
  summarise(GROUP.ID = GROUP.ID,
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species$COMMON.NAME) %>% 
  group_by(COMMON.NAME, M.YEAR, MONTH) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species)


((ggplot(filter(birds, SP.CATEGORY == "U"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "R"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "W"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Migratory year", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Bengaluru city") -> b_bang_02_annual


ggsave("03_wrap_figs/b_bang_02_annual.png", b_bang_02_annual,
       width = 10, height = 14, units = "in", dpi = 300)


```

Urban species show a wide range of patterns, often contradictory. Non-urban species do not seem to have been necessarily affected by the pandemic, but have shown a consistent increase over the years (from even before the pandemic). So, pandemic is unlikely to have had a major impact.

A lot of the patterns seemingly significant at the level of migratory year are not necessarily related to COVID. Many bird species had considerably lower reporting frequencies in even before the pandemic, for some reason. This is what is dragging the average for migratory year 2019 down for many species here. 

What happens when these patterns in urban areas are averaged across space? 

```{r b_bang_03_spatial, cache=TRUE, message=FALSE}

birds_monthly <- data0_MY_slice_G %>% 
  filter(STATE == "Karnataka") %>% 
  group_by(COVID, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(GROUP.ID = GROUP.ID, # not mutating so as to remove unwanted join columns
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species$COMMON.NAME) %>% 
  group_by(COMMON.NAME, COVID, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species)


((ggplot(filter(birds_monthly, SP.CATEGORY == "U"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "R"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "W"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Month", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Karnataka state") -> b_bang_03_spatial_m

ggsave("03_wrap_figs/b_bang_03_spatial_m.png", b_bang_03_spatial_m,
       width = 11, height = 15, units = "in", dpi = 300)



birds <- data0_MY_slice_G %>% 
  filter(STATE == "Karnataka") %>% 
  group_by(M.YEAR, MONTH, CELL.ID) %>% 
  summarise(GROUP.ID = GROUP.ID,
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species$COMMON.NAME) %>% 
  group_by(COMMON.NAME, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n()) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species)


((ggplot(filter(birds, SP.CATEGORY == "U"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "R"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "W"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 3, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.25, width = 0.2, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Migratory year", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Karnataka state") -> b_bang_03_spatial_a


ggsave("03_wrap_figs/b_bang_03_spatial_a.png", b_bang_03_spatial_a,
       width = 10, height = 14, units = "in", dpi = 300)


```

At the larger spatial scale, pandemic effects are restricted to the two months, mostly in 2020. Some urban species increased in frequency while most decreased (surprisingly) and some did not change. Most non-urban species decreased in frequency, and so did wetland species. But translated to the annual scale, non-urban species also spread out, in that there is no longer one specific direction in which frequencies of all the species changed.

Thus, there is no clear direction of change. Even the slight patterns seen in these visualisations may not have a large effect size.

```{r b_bang_04_model, cache=TRUE, message=FALSE}

require(lme4)


### modelling directly with presence-absence data instead of relative abundance

# to join for presence-absence of various species
temp1 <- data0_MY %>% 
  filter(STATE == "Karnataka") %>% 
  group_by(GROUP.ID, COMMON.NAME) %>% 
  summarise(OBSERVATION.COUNT = max(OBSERVATION.COUNT)) %>% ungroup()

# to later join checklist metadata
temp2 <- data0_MY %>% 
  filter(STATE == "Karnataka") %>% 
  arrange(SAMPLING.EVENT.IDENTIFIER) %>% 
  group_by(GROUP.ID) %>% 
  slice(1) %>% ungroup() %>% 
  select(GROUP.ID, STATE, COUNTY, LOCALITY, LATITUDE, LONGITUDE, OBSERVATION.DATE, 
         M.YEAR, MONTH, DAY.M, M.YEAR, URBAN, CELL.ID, SUBCELL.ID, NO.SP)
  
data_b2 <- data0_MY_slice_G %>% 
  filter(STATE == "Karnataka") %>% 
  group_by(GROUP.ID) %>% 
  summarise(COMMON.NAME = species$COMMON.NAME) %>% 
  left_join(temp1) %>% 
  # for species not reported in lists, filling in NAs in COMMON.NAME and REPORT
  mutate(REPORT = replace_na(OBSERVATION.COUNT, "0")) %>% 
  select(-OBSERVATION.COUNT) %>% 
  mutate(REPORT = as.numeric(case_when(REPORT != "0" ~ "1", TRUE ~ REPORT))) %>% 
  # checklist metadata
  left_join(temp2, by = "GROUP.ID") %>% 
  arrange(GROUP.ID) %>% 
  # species categories
  left_join(species) %>% 
  filter(SP.CATEGORY != "W") %>% # removing wetland spp. cos we want to compare UNU
  ungroup()


# getting median list length for prediction later
median_length <- data_b2 %>% 
  distinct(M.YEAR, MONTH, GROUP.ID, NO.SP) %>% 
  group_by(MONTH) %>% 
  summarise(NO.SP.MED = median(NO.SP))

# dataframe with empty column to populate with looped values
# total rows: product of distinct values of predictors
bang0 <- data_b2 %>% 
  tidyr::expand(COMMON.NAME, MONTH, M.YEAR) %>% 
  left_join(species) %>% 
  mutate(REP.FREQ.PRED = NA)

count <- 0
for (i in 1:n_distinct(bang0$COMMON.NAME)) {
  
  data_spec <- data_b2 %>% 
    filter(COMMON.NAME == unique(bang0$COMMON.NAME)[i]) %>% 
    # filtering for CELL.ID-MONTH (space-time) combos in which species occurs
    filter(REPORT == 1) %>% 
    distinct(COMMON.NAME, CELL.ID, MONTH) %>% 
    left_join(data_b2)

    
  model_spec <- glmer(REPORT ~ M.YEAR + MONTH + MONTH:NO.SP + MONTH:M.YEAR + 
                        (1|CELL.ID),
                      data = data_spec, family = binomial(link = "cloglog"),
                      nAGQ = 0, control = glmerControl(optimizer = "bobyqa"))
  
  for (j in 1:n_distinct(bang0$MONTH)) {
    for (k in 1:n_distinct(bang0$M.YEAR)) {
      count <- count + 1
      
      bang0$REP.FREQ.PRED[count] = predict(
        model_spec,
        data.frame(COMMON.NAME = bang0$COMMON.NAME[count],
                   MONTH = bang0$MONTH[count],
                   M.YEAR = bang0$M.YEAR[count],
                   NO.SP = median_length$NO.SP.MED[bang0$MONTH[count]]),
        re.form = NA, 
        type = "response")
    }
  }
} # 7 mins


bang1 <- bang0 %>% 
  filter(MONTH %in% 4:5) %>% 
  group_by(M.YEAR, SP.CATEGORY) %>% 
  summarise(SE = sd(REP.FREQ.PRED)/sqrt(n()),
            REP.FREQ.PRED = mean(REP.FREQ.PRED),
            CI.L = REP.FREQ.PRED - 1.96*SE,
            CI.U = REP.FREQ.PRED + 1.96*SE)

bang2 <- bang0 %>% 
  group_by(M.YEAR, SP.CATEGORY) %>% 
  summarise(SE = sd(REP.FREQ.PRED)/sqrt(n()),
            REP.FREQ.PRED = mean(REP.FREQ.PRED),
            CI.L = REP.FREQ.PRED - 1.96*SE,
            CI.U = REP.FREQ.PRED + 1.96*SE)

save(bang1, bang2, 
     file = "data/birds_bang.RData") # for presentation



(ggplot(bang1, aes(M.YEAR, REP.FREQ.PRED, col = SP.CATEGORY)) +
    scale_color_manual(values = c("#8F85C1", "#A3383C"),
                       name = "Species category",
                       labels = c("Rural", "Urban")) +
    labs(title = "For the months of April and May",
         x = "Migratory year", y = "Predicted reporting frequency") +
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.5, width = 0.2, position = position_dodge(0.5)) |
  ggplot(bang2, aes(M.YEAR, REP.FREQ.PRED, col = SP.CATEGORY)) +
    scale_color_manual(values = c("#8F85C1", "#A3383C"),
                       name = "Species category",
                       labels = c("Rural", "Urban")) +
     labs(title = "For all twelve months",
          x = "Migratory year", y = "Predicted reporting frequency") +
     geom_point(size = 3, position = position_dodge(0.5)) +
     geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                   size = 1.5, width = 0.2, position = position_dodge(0.5))) +
  plot_layout(guides = "collect") +
  plot_annotation(title = paste(unique(data_b2$STATE), "state"),
                  subtitle = paste0(
                    "Predicted reporting frequencies of ",
                    n_distinct(bang0$COMMON.NAME), " species (",
                    n_distinct(filter(bang0,SP.CATEGORY == "U")$COMMON.NAME), " urban, ",
                    n_distinct(filter(bang0,SP.CATEGORY == "R")$COMMON.NAME), " rural)")
                  ) -> b_bang_04_model

ggsave("03_wrap_figs/b_bang_04_model.png", b_bang_04_model,
       width = 16, height = 6, units = "in", dpi = 300)

```

- Non-urban birds had lower reporting frequency in MY 2020, as seen from the MY:month interaction. 
- However, at the annual level, urban species did not show a higher reporting frequency, which could be because birders in Karnataka compensated during the winter months with exceptional non-urban birding. 
- The crucial months like April and May show higher urban species reporting frequency overall.
- Changes in birder behaviour during the peak period did not translate to notable changes in reporting frequency of bird species. The slight suggestion (still insignificant) of a change in MY2019 during the peak period completely disappears at the larger temporal scale.

## Kochi

```{r b_koch_01_monthly, cache=TRUE, message=FALSE}

birds_monthly <- data0_MY_slice_G %>% 
  filter(COUNTY == "Ernakulam", CELL.ID %in% city_koch) %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  summarise(GROUP.ID = GROUP.ID, # not mutating so as to remove unwanted join columns
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species_koch$COMMON.NAME) %>%
  group_by(COMMON.NAME, COVID, M.YEAR, MONTH) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species_koch)


((ggplot(filter(birds_monthly, SP.CATEGORY == "U"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "R"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "W"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Month", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Kochi city") -> b_koch_01_monthly


ggsave("03_wrap_figs/b_koch_01_monthly.png", b_koch_01_monthly,
       width = 11, height = 15, units = "in", dpi = 300)

```

No prominent effect of the pandemic. Biggest change is in wetland birds.

```{r b_koch_02_annual, cache=TRUE, message=FALSE}

birds <- data0_MY_slice_G %>% 
  filter(COUNTY == "Ernakulam", CELL.ID %in% city_koch) %>% 
  group_by(M.YEAR, MONTH) %>% 
  summarise(GROUP.ID = GROUP.ID,
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species_koch$COMMON.NAME) %>% 
  group_by(COMMON.NAME, M.YEAR, MONTH) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species_koch)


((ggplot(filter(birds, SP.CATEGORY == "U"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "R"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "W"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Migratory year", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Kochi city") -> b_koch_02_annual


ggsave("03_wrap_figs/b_koch_02_annual.png", b_koch_02_annual,
       width = 10, height = 14, units = "in", dpi = 300)


```

No prominent effects directly attributable to the pandemic. Most patterns even out.

```{r b_koch_03_spatial, cache=TRUE, message=FALSE}

birds_monthly <- data0_MY_slice_G %>% 
  filter(STATE == "Kerala") %>% 
  group_by(COVID, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(GROUP.ID = GROUP.ID, # not mutating so as to remove unwanted join columns
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species_koch$COMMON.NAME) %>% 
  group_by(COMMON.NAME, COVID, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species_koch)


((ggplot(filter(birds_monthly, SP.CATEGORY == "U"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "R"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "W"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Month", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Kerala state") -> b_koch_03_spatial_m

ggsave("03_wrap_figs/b_koch_03_spatial_m.png", b_koch_03_spatial_m,
       width = 11, height = 15, units = "in", dpi = 300)



birds <- data0_MY_slice_G %>% 
  filter(STATE == "Kerala") %>% 
  group_by(M.YEAR, MONTH, CELL.ID) %>% 
  summarise(GROUP.ID = GROUP.ID,
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species_koch$COMMON.NAME) %>% 
  group_by(COMMON.NAME, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n()) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species_koch)


((ggplot(filter(birds, SP.CATEGORY == "U"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "R"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "W"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Migratory year", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Kerala state") -> b_koch_03_spatial_a


ggsave("03_wrap_figs/b_koch_03_spatial_a.png", b_koch_03_spatial_a,
       width = 10, height = 14, units = "in", dpi = 300)


```

3-4 non-urban species decreased during the 2-3 months of "peak" and wetland species decreased during 5-6 months of the "peak" and following it. At the annual scale, a few urban species show slightly higher frequencies during migratory year 2019, but others show different patterns. Effect sizes will need to be judged. Non-urban and wetland species were not affected in any particular direction consistently (across species) by the pandemic.

```{r b_koch_04_model, cache=TRUE, message=FALSE}

require(lme4)

### modelling directly with presence-absence data instead of relative abundance

# to join for presence-absence of various species
temp1 <- data0_MY %>% 
  filter(STATE == "Kerala") %>% 
  group_by(GROUP.ID, COMMON.NAME) %>% 
  summarise(OBSERVATION.COUNT = max(OBSERVATION.COUNT)) %>% ungroup()

# to later join checklist metadata
temp2 <- data0_MY %>% 
  filter(STATE == "Kerala") %>% 
  arrange(SAMPLING.EVENT.IDENTIFIER) %>% 
  group_by(GROUP.ID) %>% 
  slice(1) %>% ungroup() %>% 
  select(GROUP.ID, STATE, COUNTY, LOCALITY, LATITUDE, LONGITUDE, OBSERVATION.DATE, 
         M.YEAR, MONTH, DAY.M, M.YEAR, URBAN, CELL.ID, SUBCELL.ID, NO.SP)
  
data_b2 <- data0_MY_slice_G %>% 
  filter(STATE == "Kerala") %>% 
  group_by(GROUP.ID) %>% 
  summarise(COMMON.NAME = species_koch$COMMON.NAME) %>% 
  left_join(temp1) %>% 
  # for species not reported in lists, filling in NAs in COMMON.NAME and REPORT
  mutate(REPORT = replace_na(OBSERVATION.COUNT, "0")) %>% 
  select(-OBSERVATION.COUNT) %>% 
  mutate(REPORT = as.numeric(case_when(REPORT != "0" ~ "1", TRUE ~ REPORT))) %>% 
  # checklist metadata
  left_join(temp2, by = "GROUP.ID") %>% 
  arrange(GROUP.ID) %>% 
  # species categories
  left_join(species_koch) %>% 
  filter(SP.CATEGORY != "W") %>% # removing wetland spp. cos we want to compare UNU
  ungroup()


# getting median list length for prediction later
median_length <- data_b2 %>% 
  distinct(M.YEAR, MONTH, GROUP.ID, NO.SP) %>% 
  group_by(MONTH) %>% 
  summarise(NO.SP.MED = median(NO.SP))

# dataframe with empty column to populate with looped values
# total rows: product of distinct values of predictors
koch0 <- data_b2 %>% 
  tidyr::expand(COMMON.NAME, MONTH, M.YEAR) %>% 
  left_join(species_koch) %>% 
  mutate(REP.FREQ.PRED = NA)

count <- 0
for (i in 1:n_distinct(koch0$COMMON.NAME)) {
  
  data_spec <- data_b2 %>% 
    filter(COMMON.NAME == unique(koch0$COMMON.NAME)[i]) %>% 
    # filtering for CELL.ID-MONTH (space-time) combos in which species occurs
    filter(REPORT == 1) %>% 
    distinct(COMMON.NAME, CELL.ID, MONTH) %>% 
    left_join(data_b2)
  
  model_spec <- glmer(REPORT ~ M.YEAR + MONTH + MONTH:NO.SP + MONTH:M.YEAR + 
                        (1|CELL.ID),
                      data = data_spec, family = binomial(link = "cloglog"),
                      nAGQ = 0, control = glmerControl(optimizer = "bobyqa"))
  
  for (j in 1:n_distinct(koch0$MONTH)) {
    for (k in 1:n_distinct(koch0$M.YEAR)) {
      count <- count + 1
      
      koch0$REP.FREQ.PRED[count] = predict(
        model_spec,
        data.frame(COMMON.NAME = koch0$COMMON.NAME[count],
                   MONTH = koch0$MONTH[count],
                   M.YEAR = koch0$M.YEAR[count],
                   NO.SP = median_length$NO.SP.MED[koch0$MONTH[count]]),
        re.form = NA, 
        type = "response")
    }
  }
}

koch1 <- koch0 %>% 
  filter(MONTH %in% 4:5) %>% 
  group_by(M.YEAR, SP.CATEGORY) %>% 
  summarise(SE = sd(REP.FREQ.PRED)/sqrt(n()),
            REP.FREQ.PRED = mean(REP.FREQ.PRED),
            CI.L = REP.FREQ.PRED - 1.96*SE,
            CI.U = REP.FREQ.PRED + 1.96*SE)

koch2 <- koch0 %>% 
  group_by(M.YEAR, SP.CATEGORY) %>% 
  summarise(SE = sd(REP.FREQ.PRED)/sqrt(n()),
            REP.FREQ.PRED = mean(REP.FREQ.PRED),
            CI.L = REP.FREQ.PRED - 1.96*SE,
            CI.U = REP.FREQ.PRED + 1.96*SE)


(ggplot(koch1, aes(M.YEAR, REP.FREQ.PRED, col = SP.CATEGORY)) +
    scale_color_manual(values = c("#8F85C1", "#A3383C"),
                       name = "Species category",
                       labels = c("Rural", "Urban")) +
    labs(title = "For the months of April and May",
         x = "Migratory year", y = "Predicted reporting frequency") +
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.5, width = 0.2, position = position_dodge(0.5)) |
  ggplot(koch2, aes(M.YEAR, REP.FREQ.PRED, col = SP.CATEGORY)) +
    scale_color_manual(values = c("#8F85C1", "#A3383C"),
                       name = "Species category",
                       labels = c("Rural", "Urban")) +
     labs(title = "For all twelve months",
          x = "Migratory year", y = "Predicted reporting frequency") +
     geom_point(size = 3, position = position_dodge(0.5)) +
     geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                   size = 1.5, width = 0.2, position = position_dodge(0.5))) +
  plot_layout(guides = "collect") +
  plot_annotation(title = paste(unique(data_b2$STATE), "state"),
                  subtitle = paste0(
                    "Predicted reporting frequencies of ",
                    n_distinct(koch0$COMMON.NAME), " species (",
                    n_distinct(filter(koch0,SP.CATEGORY == "U")$COMMON.NAME), " urban, ",
                    n_distinct(filter(koch0,SP.CATEGORY == "R")$COMMON.NAME), " rural)")
                  ) -> b_koch_04_model

ggsave("03_wrap_figs/b_koch_04_model.png", b_koch_04_model,
       width = 16, height = 6, units = "in", dpi = 300)

```


## Pune

```{r b_pune_01_monthly, cache=TRUE, message=FALSE}

birds_monthly <- data0_MY_slice_G %>% 
  filter(COUNTY == "Pune", CELL.ID %in% city_pune) %>% 
  group_by(COVID, M.YEAR, MONTH) %>% 
  summarise(GROUP.ID = GROUP.ID, # not mutating so as to remove unwanted join columns
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species$COMMON.NAME, 
         COMMON.NAME != "White-cheeked Barbet") %>% 
  group_by(COMMON.NAME, COVID, M.YEAR, MONTH) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species)


((ggplot(filter(birds_monthly, SP.CATEGORY == "U"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "R"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "W"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Month", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Pune city") -> b_pune_01_monthly


ggsave("03_wrap_figs/b_pune_01_monthly.png", b_pune_01_monthly,
       width = 11, height = 15, units = "in", dpi = 300)

```

Many non-urban and wetland bird species showed a slight decrease in reporting frequency during the "peak" period, but none of the urban species did. Also, WCBa is rare in Pune city so can be ignored at this level.

```{r b_pune_02_annual, cache=TRUE, message=FALSE}

birds <- data0_MY_slice_G %>% 
  filter(COUNTY == "Pune", CELL.ID %in% city_pune) %>% 
  group_by(M.YEAR, MONTH) %>% 
  summarise(GROUP.ID = GROUP.ID,
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species$COMMON.NAME, 
         COMMON.NAME != "White-cheeked Barbet") %>% 
  group_by(COMMON.NAME, M.YEAR, MONTH) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species)


((ggplot(filter(birds, SP.CATEGORY == "U"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "R"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "W"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Migratory year", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Pune city") -> b_pune_02_annual


ggsave("03_wrap_figs/b_pune_02_annual.png", b_pune_02_annual,
       width = 10, height = 14, units = "in", dpi = 300)


```

There is no clear direction of change with the pandemic in Pune city. What happens when considering a larger spatial scale?

```{r b_pune_03_spatial, cache=TRUE, message=FALSE}

birds_monthly <- data0_MY_slice_G %>% 
  filter(STATE == "Maharashtra") %>% 
  group_by(COVID, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(GROUP.ID = GROUP.ID, # not mutating so as to remove unwanted join columns
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species$COMMON.NAME, 
         COMMON.NAME != "White-cheeked Barbet") %>% 
  group_by(COMMON.NAME, COVID, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species)


((ggplot(filter(birds_monthly, SP.CATEGORY == "U"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "R"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "W"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Month", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Maharashtra state") -> b_pune_03_spatial_m

ggsave("03_wrap_figs/b_pune_03_spatial_m.png", b_pune_03_spatial_m,
       width = 11, height = 15, units = "in", dpi = 300)



birds <- data0_MY_slice_G %>% 
  filter(STATE == "Maharashtra") %>% 
  group_by(M.YEAR, MONTH, CELL.ID) %>% 
  summarise(GROUP.ID = GROUP.ID,
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species$COMMON.NAME, 
         COMMON.NAME != "White-cheeked Barbet") %>% 
  group_by(COMMON.NAME, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n()) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species)


((ggplot(filter(birds, SP.CATEGORY == "U"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "R"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "W"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Migratory year", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Maharashtra state") -> b_pune_03_spatial_a


ggsave("03_wrap_figs/b_pune_03_spatial_a.png", b_pune_03_spatial_a,
       width = 10, height = 14, units = "in", dpi = 300)


```

At the larger spatial scale, pandemic effects are restricted to the "peak" period, mostly in 2020. Most species decreased (surprisingly, including urban ones) in frequency. But translated to the annual scale, non-urban species also spread out, in that there is no longer one specific direction in which frequencies of all the species changed. Only urban species seem to show a decrease in frequency, probably due to increased birding in non-urban areas over the years.

```{r b_pune_04_model, cache=TRUE, message=FALSE}

require(lme4)

# removing Black Drongo for models to run
species <- data.frame(
  COMMON.NAME = c("House Crow", "Common Myna", "Jungle Myna", "Rock Pigeon", "Black Kite", "Common Tailorbird", "Rose-ringed Parakeet", "Asian Koel", "Purple Sunbird", "Pale-billed Flowerpecker", "White-cheeked Barbet", 
                  "Little Cormorant", "Gray-headed Swamphen", "Indian Pond-Heron",
                  "Green Bee-eater", "Pied Bushchat", "Plain Prinia", "Indian Robin", "House Sparrow", "Spotted Dove", "Coppersmith Barbet", "Black-winged Kite", "Small Minivet", "Long-tailed Shrike", "Gray Francolin"),
  SP.CATEGORY = c(rep("U", 11), rep("W", 3), rep("R", 11)))


### modelling directly with presence-absence data instead of relative abundance

# to join for presence-absence of various species
temp1 <- data0_MY %>% 
  filter(STATE == "Maharashtra") %>% 
  group_by(GROUP.ID, COMMON.NAME) %>% 
  summarise(OBSERVATION.COUNT = max(OBSERVATION.COUNT)) %>% ungroup()

# to later join checklist metadata
temp2 <- data0_MY %>% 
  filter(STATE == "Maharashtra") %>% 
  arrange(SAMPLING.EVENT.IDENTIFIER) %>% 
  group_by(GROUP.ID) %>% 
  slice(1) %>% ungroup() %>% 
  select(GROUP.ID, STATE, COUNTY, LOCALITY, LATITUDE, LONGITUDE, OBSERVATION.DATE, 
         M.YEAR, MONTH, DAY.M, M.YEAR, URBAN, CELL.ID, SUBCELL.ID, NO.SP)
  
data_b2 <- data0_MY_slice_G %>% 
  filter(STATE == "Maharashtra") %>% 
  group_by(GROUP.ID) %>% 
  summarise(COMMON.NAME = species$COMMON.NAME) %>% 
  left_join(temp1) %>% 
  # for species not reported in lists, filling in NAs in COMMON.NAME and REPORT
  mutate(REPORT = replace_na(OBSERVATION.COUNT, "0")) %>% 
  select(-OBSERVATION.COUNT) %>% 
  mutate(REPORT = as.numeric(case_when(REPORT != "0" ~ "1", TRUE ~ REPORT))) %>% 
  # checklist metadata
  left_join(temp2, by = "GROUP.ID") %>% 
  arrange(GROUP.ID) %>% 
  # species categories
  left_join(species) %>% 
  filter(SP.CATEGORY != "W") %>% # removing wetland spp. cos we want to compare UNU
  ungroup()


# getting median list length for prediction later
median_length <- data_b2 %>% 
  distinct(M.YEAR, MONTH, GROUP.ID, NO.SP) %>% 
  group_by(MONTH) %>% 
  summarise(NO.SP.MED = median(NO.SP))

# dataframe with empty column to populate with looped values
# total rows: product of distinct values of predictors
pune0 <- data_b2 %>% 
  tidyr::expand(COMMON.NAME, MONTH, M.YEAR) %>% 
  left_join(species) %>% 
  mutate(REP.FREQ.PRED = NA)


count <- 0
for (i in 1:n_distinct(pune0$COMMON.NAME)) {
  
  data_spec <- data_b2 %>% 
    filter(COMMON.NAME == unique(pune0$COMMON.NAME)[i]) %>% 
    # filtering for CELL.ID-MONTH (space-time) combos in which species occurs
    filter(REPORT == 1) %>% 
    distinct(COMMON.NAME, CELL.ID, MONTH) %>% 
    left_join(data_b2)
  
  model_spec <- glmer(REPORT ~ M.YEAR + MONTH + MONTH:NO.SP + MONTH:M.YEAR + 
                        (1|CELL.ID),
                      data = data_spec, family = binomial(link = "cloglog"),
                      nAGQ = 0, control = glmerControl(optimizer = "bobyqa"))
  
  for (j in 1:n_distinct(pune0$MONTH)) {
    for (k in 1:n_distinct(pune0$M.YEAR)) {
      count <- count + 1
      
      pune0$REP.FREQ.PRED[count] = predict(
        model_spec,
        data.frame(COMMON.NAME = pune0$COMMON.NAME[count],
                   MONTH = pune0$MONTH[count],
                   M.YEAR = pune0$M.YEAR[count],
                   NO.SP = median_length$NO.SP.MED[pune0$MONTH[count]]),
        re.form = NA, 
        type = "response")
    }
  }
}

pune1 <- pune0 %>% 
  filter(MONTH %in% 4:5) %>% 
  group_by(M.YEAR, SP.CATEGORY) %>% 
  summarise(SE = sd(REP.FREQ.PRED)/sqrt(n()),
            REP.FREQ.PRED = mean(REP.FREQ.PRED),
            CI.L = REP.FREQ.PRED - 1.96*SE,
            CI.U = REP.FREQ.PRED + 1.96*SE)

pune2 <- pune0 %>% 
  group_by(M.YEAR, SP.CATEGORY) %>% 
  summarise(SE = sd(REP.FREQ.PRED)/sqrt(n()),
            REP.FREQ.PRED = mean(REP.FREQ.PRED),
            CI.L = REP.FREQ.PRED - 1.96*SE,
            CI.U = REP.FREQ.PRED + 1.96*SE)


(ggplot(pune1, aes(M.YEAR, REP.FREQ.PRED, col = SP.CATEGORY)) +
    scale_color_manual(values = c("#8F85C1", "#A3383C"),
                       name = "Species category",
                       labels = c("Rural", "Urban")) +
    labs(title = "For the months of April and May",
         x = "Migratory year", y = "Predicted reporting frequency") +
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.5, width = 0.2, position = position_dodge(0.5)) |
  ggplot(pune2, aes(M.YEAR, REP.FREQ.PRED, col = SP.CATEGORY)) +
    scale_color_manual(values = c("#8F85C1", "#A3383C"),
                       name = "Species category",
                       labels = c("Rural", "Urban")) +
     labs(title = "For all twelve months",
          x = "Migratory year", y = "Predicted reporting frequency") +
     geom_point(size = 3, position = position_dodge(0.5)) +
     geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                   size = 1.5, width = 0.2, position = position_dodge(0.5))) +
  plot_layout(guides = "collect") +
  plot_annotation(title = paste(unique(data_b2$STATE), "state"),
                  subtitle = paste0(
                    "Predicted reporting frequencies of ",
                    n_distinct(pune0$COMMON.NAME), " species (",
                    n_distinct(filter(pune0,SP.CATEGORY == "U")$COMMON.NAME), " urban, ",
                    n_distinct(filter(pune0,SP.CATEGORY == "R")$COMMON.NAME), " rural)")
                  ) -> b_pune_04_model

ggsave("03_wrap_figs/b_pune_04_model.png", b_pune_04_model,
       width = 16, height = 6, units = "in", dpi = 300)

```


## Guwahati

Not enough lists in each month to analyse at this scale. 

```{r b_guwa_02_annual, cache=TRUE, message=FALSE}

birds <- data0_MY_slice_G %>% 
  filter(COUNTY == "Kamrup Metropolitan", CELL.ID %in% city_guwa) %>% 
  group_by(M.YEAR, MONTH) %>% 
  summarise(GROUP.ID = GROUP.ID,
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species_guwa$COMMON.NAME) %>% 
  group_by(COMMON.NAME, M.YEAR, MONTH) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species_guwa)


((ggplot(filter(birds, SP.CATEGORY == "U"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "R"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "W"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Migratory year", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Guwahati city") -> b_guwa_02_annual


ggsave("03_wrap_figs/b_guwa_02_annual.png", b_guwa_02_annual,
       width = 10, height = 14, units = "in", dpi = 300)


```

Non-urban and wetland species do not show an impact, while some urban species did have slightly higher frequencies in migratory year 2019. However, confidence intervals are mostly overlapping and effect size is likely small.

```{r b_guwa_03_spatial, cache=TRUE, message=FALSE}

birds_monthly <- data0_MY_slice_G %>% 
  filter(STATE == "Assam") %>% 
  group_by(COVID, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(GROUP.ID = GROUP.ID, # not mutating so as to remove unwanted join columns
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species_guwa$COMMON.NAME) %>% 
  group_by(COMMON.NAME, COVID, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species_guwa)


((ggplot(filter(birds_monthly, SP.CATEGORY == "U"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "R"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Month", y = "Reporting frequency")) /
(ggplot(filter(birds_monthly, SP.CATEGORY == "W"), 
       aes(MONTH, REP.FREQ, colour = COVID)) +
  geom_point(size = 1.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1, width = 0.6, position = position_dodge(0.5)) +
  scale_x_continuous(breaks = 1:12) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Month", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Assam state") -> b_guwa_03_spatial_m

ggsave("03_wrap_figs/b_guwa_03_spatial_m.png", b_guwa_03_spatial_m,
       width = 11, height = 15, units = "in", dpi = 300)



birds <- data0_MY_slice_G %>% 
  filter(STATE == "Assam") %>% 
  group_by(M.YEAR, MONTH, CELL.ID) %>% 
  summarise(GROUP.ID = GROUP.ID,
            TOT.LISTS = n_distinct(GROUP.ID)) %>% 
  left_join(data0) %>% 
  filter(COMMON.NAME %in% species_guwa$COMMON.NAME) %>% 
  group_by(COMMON.NAME, M.YEAR, MONTH, CELL.ID) %>% 
  summarise(TOT.LISTS = min(TOT.LISTS),
            NO.LISTS = n_distinct(GROUP.ID),
            REP.FREQ = round(NO.LISTS/TOT.LISTS, 4),
            # not bootstrapping here cos only averaging across 12 months
            # using binomial confidence
            SE = sqrt((REP.FREQ)*(1 - REP.FREQ)/TOT.LISTS)) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n()) %>% 
  summarise(REP.FREQ = mean(REP.FREQ),
            SE = sqrt(sum((SE)^2))/n(),
            CI.L = REP.FREQ - 1.96*SE,
            CI.U = REP.FREQ + 1.96*SE) %>% 
  left_join(species_guwa)


((ggplot(filter(birds, SP.CATEGORY == "U"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "R"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Non-urban species",
       x = "Migratory year", y = "Reporting frequency")) /
(ggplot(filter(birds, SP.CATEGORY == "W"), 
       aes(M.YEAR, REP.FREQ)) +
  geom_point(size = 2.5, position = position_dodge(0.5)) +
  geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                size = 1.1, width = 0.1, position = position_dodge(0.5)) +
  scale_colour_manual(values = covid_palette) +
  facet_wrap(~COMMON.NAME, dir = "h", ncol = 3, strip.position = "left", scales = "free_y") +
  theme(strip.text = element_text(size = 7)) +
  labs(title = "Wetland species",
       x = "Migratory year", y = "Reporting frequency"))) +
plot_layout(guides = "collect", heights = c(4, 4, 1)) +
plot_annotation(title = "Assam state") -> b_guwa_03_spatial_a


ggsave("03_wrap_figs/b_guwa_03_spatial_a.png", b_guwa_03_spatial_a,
       width = 10, height = 14, units = "in", dpi = 300)


```

Very minor suggestions of changes during the 2 month period in a few species, but overall no pattern. At the annual scale, wetland species show some differences, but others show no overall change in reporting frequency due to the pandemic.

```{r b_guwa_04_model, cache=TRUE, message=FALSE}

require(lme4)

### modelling directly with presence-absence data instead of relative abundance

# to join for presence-absence of various species
temp1 <- data0_MY %>% 
  filter(STATE == "Assam") %>% 
  group_by(GROUP.ID, COMMON.NAME) %>% 
  summarise(OBSERVATION.COUNT = max(OBSERVATION.COUNT)) %>% ungroup()

# to later join checklist metadata
temp2 <- data0_MY %>% 
  filter(STATE == "Assam") %>% 
  arrange(SAMPLING.EVENT.IDENTIFIER) %>% 
  group_by(GROUP.ID) %>% 
  slice(1) %>% ungroup() %>% 
  select(GROUP.ID, STATE, COUNTY, LOCALITY, LATITUDE, LONGITUDE, OBSERVATION.DATE, 
         M.YEAR, MONTH, DAY.M, M.YEAR, URBAN, CELL.ID, SUBCELL.ID, NO.SP)
  
data_b2 <- data0_MY_slice_G %>% 
  filter(STATE == "Assam") %>% 
  group_by(GROUP.ID) %>% 
  summarise(COMMON.NAME = species_guwa$COMMON.NAME) %>% 
  left_join(temp1) %>% 
  # for species not reported in lists, filling in NAs in COMMON.NAME and REPORT
  mutate(REPORT = replace_na(OBSERVATION.COUNT, "0")) %>% 
  select(-OBSERVATION.COUNT) %>% 
  mutate(REPORT = as.numeric(case_when(REPORT != "0" ~ "1", TRUE ~ REPORT))) %>% 
  # checklist metadata
  left_join(temp2, by = "GROUP.ID") %>% 
  arrange(GROUP.ID) %>% 
  # species categories
  left_join(species_guwa) %>% 
  filter(SP.CATEGORY != "W") %>% # removing wetland spp. cos we want to compare UNU
  ungroup()


# getting median list length for prediction later
median_length <- data_b2 %>% 
  distinct(M.YEAR, MONTH, GROUP.ID, NO.SP) %>% 
  group_by(MONTH) %>% 
  summarise(NO.SP.MED = median(NO.SP))

# dataframe with empty column to populate with looped values
# total rows: product of distinct values of predictors
guwa0 <- data_b2 %>% 
  tidyr::expand(COMMON.NAME, MONTH, M.YEAR) %>% 
  left_join(species_guwa) %>% 
  mutate(REP.FREQ.PRED = NA)

count <- 0
for (i in 1:n_distinct(guwa0$COMMON.NAME)) {
  
  data_spec <- data_b2 %>% 
    filter(COMMON.NAME == unique(guwa0$COMMON.NAME)[i]) %>% 
    # filtering for CELL.ID-MONTH (space-time) combos in which species occurs
    filter(REPORT == 1) %>% 
    distinct(COMMON.NAME, CELL.ID, MONTH) %>% 
    left_join(data_b2)
  
  model_spec <- glmer(REPORT ~ M.YEAR + MONTH + MONTH:NO.SP + MONTH:M.YEAR + 
                        (1|CELL.ID),
                      data = data_spec, family = binomial(link = "cloglog"),
                      nAGQ = 0, control = glmerControl(optimizer = "bobyqa"))
  
  for (j in 1:n_distinct(guwa0$MONTH)) {
    for (k in 1:n_distinct(guwa0$M.YEAR)) {
      count <- count + 1
      
      guwa0$REP.FREQ.PRED[count] = predict(
        model_spec,
        data.frame(COMMON.NAME = guwa0$COMMON.NAME[count],
                   MONTH = guwa0$MONTH[count],
                   M.YEAR = guwa0$M.YEAR[count],
                   NO.SP = median_length$NO.SP.MED[guwa0$MONTH[count]]),
        re.form = NA, 
        type = "response")
    }
  }
}

guwa1 <- guwa0 %>% 
  filter(MONTH %in% 4:5) %>% 
  group_by(M.YEAR, SP.CATEGORY) %>% 
  summarise(SE = sd(REP.FREQ.PRED)/sqrt(n()),
            REP.FREQ.PRED = mean(REP.FREQ.PRED),
            CI.L = REP.FREQ.PRED - 1.96*SE,
            CI.U = REP.FREQ.PRED + 1.96*SE)

guwa2 <- guwa0 %>% 
  group_by(M.YEAR, SP.CATEGORY) %>% 
  summarise(SE = sd(REP.FREQ.PRED)/sqrt(n()),
            REP.FREQ.PRED = mean(REP.FREQ.PRED),
            CI.L = REP.FREQ.PRED - 1.96*SE,
            CI.U = REP.FREQ.PRED + 1.96*SE)


(ggplot(guwa1, aes(M.YEAR, REP.FREQ.PRED, col = SP.CATEGORY)) +
    scale_color_manual(values = c("#8F85C1", "#A3383C"),
                       name = "Species category",
                       labels = c("Rural", "Urban")) +
    labs(title = "For the months of April and May",
         x = "Migratory year", y = "Predicted reporting frequency") +
    geom_point(size = 3, position = position_dodge(0.5)) +
    geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                  size = 1.5, width = 0.2, position = position_dodge(0.5)) |
  ggplot(guwa2, aes(M.YEAR, REP.FREQ.PRED, col = SP.CATEGORY)) +
    scale_color_manual(values = c("#8F85C1", "#A3383C"),
                       name = "Species category",
                       labels = c("Rural", "Urban")) +
     labs(title = "For all twelve months",
          x = "Migratory year", y = "Predicted reporting frequency") +
     geom_point(size = 3, position = position_dodge(0.5)) +
     geom_errorbar(aes(ymin = CI.L, ymax = CI.U), 
                   size = 1.5, width = 0.2, position = position_dodge(0.5))) +
  plot_layout(guides = "collect") +
  plot_annotation(title = paste(unique(data_b2$STATE), "state"),
                  subtitle = paste0(
                    "Predicted reporting frequencies of ",
                    n_distinct(guwa0$COMMON.NAME), " species (",
                    n_distinct(filter(guwa0,SP.CATEGORY == "U")$COMMON.NAME), " urban, ",
                    n_distinct(filter(guwa0,SP.CATEGORY == "R")$COMMON.NAME), " rural)")
                  ) -> b_guwa_04_model

ggsave("03_wrap_figs/b_guwa_04_model.png", b_guwa_04_model,
       width = 16, height = 6, units = "in", dpi = 300)

```

- Unlike other states, Assam shows a bias in reporting towards urban species even at the annual and state-wide scale.  
- The increase in urban birding proportion is only relative to MY2018, and not to MY2020, although the trend seems to be negative post-MY2019.  
- How is this related to Bihu Bird Count (did it start in MY2019?), and to general rise in popularity of birding as well as skill of birders in Assam?

# References

